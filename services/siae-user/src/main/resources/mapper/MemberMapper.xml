<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hngy.siae.user.mapper.MemberMapper">

    <sql id="MemberColumns">
        m.id,
        m.user_id AS userId,
        d.name AS departmentName,
        p.name AS positionName,
        m.status,
        CASE m.status
            WHEN 1 THEN '在校'
            WHEN 2 THEN '离校'
            WHEN 3 THEN '毕业'
            ELSE '未知'
        END AS statusName,
        m.join_date AS joinDate,
        m.created_at AS createAt,
        m.updated_at AS updateAt
    </sql>

    <sql id="MemberJoins">
        FROM member m
        LEFT JOIN department d ON m.department_id = d.id
        LEFT JOIN position p ON m.position_id = p.id
        LEFT JOIN user u ON m.user_id = u.id
        LEFT JOIN user_profile up ON m.user_id = up.user_id
    </sql>

    <sql id="MemberWhere">
        WHERE m.is_deleted = 0
        <if test="query != null">
            <if test="query.id != null">
                AND m.id = #{query.id}
            </if>
            <if test="query.userId != null">
                AND m.user_id = #{query.userId}
            </if>
            <if test="query.departmentId != null">
                AND m.department_id = #{query.departmentId}
            </if>
            <if test="query.positionId != null">
                AND m.position_id = #{query.positionId}
            </if>
            <if test="query.studentId != null and query.studentId != ''">
                AND m.student_id = #{query.studentId}
            </if>
            <if test="query.status != null">
                AND m.status = #{query.status}
            </if>
            <if test="query.joinDateStart != null">
                AND m.join_date &gt;= #{query.joinDateStart}
            </if>
            <if test="query.joinDateEnd != null">
                AND m.join_date &lt;= #{query.joinDateEnd}
            </if>
            <if test="query.username != null and query.username != ''">
                AND u.username LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.realName != null and query.realName != ''">
                AND up.real_name LIKE CONCAT('%', #{query.realName}, '%')
            </if>
        </if>
    </sql>

    <select id="selectMemberDetailById" resultType="com.hngy.siae.user.dto.response.MemberVO">
        SELECT
        <include refid="MemberColumns"/>
        <include refid="MemberJoins"/>
        WHERE m.is_deleted = 0
          AND m.id = #{id}
    </select>

    <select id="selectMemberDetailByUserId" resultType="com.hngy.siae.user.dto.response.MemberVO">
        SELECT
        <include refid="MemberColumns"/>
        <include refid="MemberJoins"/>
        WHERE m.is_deleted = 0
          AND m.user_id = #{userId}
    </select>

    <select id="selectMemberDetails" resultType="com.hngy.siae.user.dto.response.MemberVO">
        SELECT
        <include refid="MemberColumns"/>
        <include refid="MemberJoins"/>
        <include refid="MemberWhere"/>
        ORDER BY m.created_at DESC
    </select>

    <select id="selectMemberDetailsPage" resultType="com.hngy.siae.user.dto.response.MemberVO">
        SELECT
        <include refid="MemberColumns"/>
        <include refid="MemberJoins"/>
        <include refid="MemberWhere"/>
        ORDER BY m.created_at DESC
    </select>

</mapper>
