<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hngy.siae.user.mapper.UserMapper">

    <!-- 查询用户详细信息（三表联查） -->
    <select id="selectUserDetailById" resultType="com.hngy.siae.user.dto.response.UserDetailVO">
        SELECT
            -- 用户基本信息
            u.id,
            u.username,
            u.student_id AS studentId,
            u.avatar_file_id AS avatarFileId,
            u.status,
            u.created_at AS createdAt,
            u.updated_at AS updatedAt,
            
            -- 用户详情信息
            up.real_name AS realName,
            up.nickname,
            up.email,
            up.phone,
            up.bio,
            up.gender,
            up.birthday,
            up.id_card AS idCard,
            up.qq,
            up.wechat,
            up.background_file_id AS backgroundFileId,
            
            -- 班级关联信息
            mce.major_id AS majorId,
            m.name AS majorName,
            mce.entry_year AS entryYear,
            mce.class_no AS classNo,
            CONCAT(
                COALESCE(NULLIF(m.abbr, ''), m.name),
                RIGHT(mce.entry_year, 2),
                '-',
                mce.class_no,
                '班'
            ) AS className,
            mce.member_type AS memberType,
            
            -- 协会成员信息（仅当 member_type = 1 时有值）
            ms.join_date AS joinDate
        FROM user u
        LEFT JOIN user_profile up ON u.id = up.user_id
        LEFT JOIN major_class_enrollment mce ON u.id = mce.user_id AND mce.is_deleted = 0
        LEFT JOIN major m ON mce.major_id = m.id
        LEFT JOIN membership ms ON u.id = ms.user_id AND mce.member_type = 1 AND ms.is_deleted = 0
        WHERE u.id = #{userId}
          AND u.is_deleted = 0
    </select>

    <!-- 根据条件查询用户详细信息（三表联查，支持多条件组合） -->
    <select id="selectUserDetail" resultType="com.hngy.siae.user.dto.response.UserDetailVO">
        SELECT
            -- 用户基本信息
            u.id,
            u.username,
            u.student_id AS studentId,
            u.avatar_file_id AS avatarFileId,
            u.status,
            u.created_at AS createdAt,
            u.updated_at AS updatedAt,
            
            -- 用户详情信息
            up.real_name AS realName,
            up.nickname,
            up.email,
            up.phone,
            up.bio,
            up.gender,
            up.birthday,
            up.id_card AS idCard,
            up.qq,
            up.wechat,
            up.background_file_id AS backgroundFileId,
            
            -- 班级关联信息
            mce.major_id AS majorId,
            m.name AS majorName,
            mce.entry_year AS entryYear,
            mce.class_no AS classNo,
            CONCAT(
                COALESCE(NULLIF(m.abbr, ''), m.name),
                RIGHT(mce.entry_year, 2),
                '-',
                mce.class_no,
                '班'
            ) AS className,
            mce.member_type AS memberType,
            
            -- 协会成员信息（仅当 member_type = 1 时有值）
            ms.join_date AS joinDate
        FROM user u
        LEFT JOIN user_profile up ON u.id = up.user_id
        LEFT JOIN major_class_enrollment mce ON u.id = mce.user_id AND mce.is_deleted = 0
        LEFT JOIN major m ON mce.major_id = m.id
        LEFT JOIN membership ms ON u.id = ms.user_id AND mce.member_type = 1 AND ms.is_deleted = 0
        WHERE u.is_deleted = 0
        <if test="id != null">
            AND u.id = #{id}
        </if>
        <if test="username != null and username != ''">
            AND u.username = #{username}
        </if>
        <if test="studentId != null and studentId != ''">
            AND u.student_id = #{studentId}
        </if>
        LIMIT 1
    </select>

    <!-- 分页查询用户列表（联表查询） -->
    <select id="selectUsersByPage" resultType="com.hngy.siae.user.dto.response.UserVO">
        SELECT
            u.id,
            u.username,
            u.student_id AS studentId,
            up.nickname,
            up.real_name AS realName,
            up.email,
            u.avatar_file_id AS avatarFileId,
            u.status,
            u.created_at AS createAt,
            u.updated_at AS updateAt
        FROM user u
        LEFT JOIN user_profile up ON u.id = up.user_id
        WHERE u.is_deleted = 0
        <if test="username != null and username != ''">
            AND u.username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="studentId != null and studentId != ''">
            AND u.student_id LIKE CONCAT('%', #{studentId}, '%')
        </if>
        <if test="realName != null and realName != ''">
            AND up.real_name LIKE CONCAT('%', #{realName}, '%')
        </if>
        <if test="email != null and email != ''">
            AND up.email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="status != null">
            AND u.status = #{status}
        </if>
        ORDER BY u.created_at DESC
    </select>

</mapper>
