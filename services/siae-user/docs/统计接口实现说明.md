# 统计接口实现说明

## 已完成的工作

### 1. DTO类（11个）
位置：`src/main/java/com/hngy/siae/user/dto/response/statistics/`

- `MemberOverviewVO.java` - 成员概览统计
- `DepartmentStatVO.java` - 部门统计
- `AwardOverviewVO.java` - 获奖概览统计
- `AwardDistributionVO.java` - 获奖分布统计（等级/类型）
- `TrendVO.java` - 趋势统计（通用）
- `AwardRankVO.java` - 获奖排行榜
- `GenderStatVO.java` - 性别统计
- `GradeStatVO.java` - 年级统计
- `MajorStatVO.java` - 专业统计
- `PositionStatVO.java` - 职位统计
- `MembershipTrendVO.java` - 入会趋势统计

### 2. Service层
- `StatisticsService.java` - 统计服务接口
- `StatisticsServiceImpl.java` - 统计服务实现

### 3. Mapper层
- `StatisticsMapper.java` - 统计Mapper接口
- `StatisticsMapper.xml` - MyBatis SQL映射文件

### 4. Controller层
- `StatisticsController.java` - 统计控制器（12个接口）

## 接口列表

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/v1/users/statistics/overview` | GET | 成员概览统计 |
| `/api/v1/users/statistics/departments` | GET | 部门分布统计 |
| `/api/v1/users/statistics/awards/overview` | GET | 获奖概览统计 |
| `/api/v1/users/statistics/awards/by-level` | GET | 按奖项等级分布 |
| `/api/v1/users/statistics/awards/by-type` | GET | 按奖项类型分布 |
| `/api/v1/users/statistics/awards/trend` | GET | 获奖趋势 |
| `/api/v1/users/statistics/awards/top` | GET | 获奖排行榜 |
| `/api/v1/users/statistics/demographics/gender` | GET | 性别分布 |
| `/api/v1/users/statistics/demographics/grade` | GET | 年级分布 |
| `/api/v1/users/statistics/demographics/major` | GET | 专业分布 |
| `/api/v1/users/statistics/positions` | GET | 职位分布 |
| `/api/v1/users/statistics/membership/trend` | GET | 入会趋势 |

## 测试方法

### 1. 启动服务
```bash
cd siae/services/siae-user
mvn spring-boot:run
```

### 2. 访问Swagger文档
```
http://localhost:8082/swagger-ui.html
```
（端口号根据实际配置调整）

### 3. 测试接口示例

#### 获取成员概览
```bash
curl -X GET "http://localhost:8082/api/v1/users/statistics/overview" \
  -H "Authorization: Bearer {your_token}"
```

#### 获取获奖趋势（最近6个月）
```bash
curl -X GET "http://localhost:8082/api/v1/users/statistics/awards/trend?period=month&limit=6" \
  -H "Authorization: Bearer {your_token}"
```

#### 获取获奖排行榜TOP 20
```bash
curl -X GET "http://localhost:8082/api/v1/users/statistics/awards/top?limit=20" \
  -H "Authorization: Bearer {your_token}"
```

## 注意事项

### 1. 权限控制
目前所有统计接口都需要登录，但没有添加具体的权限注解。如果需要限制只有管理员才能访问，可以在Controller方法上添加：
```java
@SiaeAuthorize("hasAuthority('USER_STATISTICS_VIEW')")
```

### 2. 头像URL处理
获奖排行榜接口返回的 `avatarUrl` 字段目前只是 `avatarFileId`，需要调用Media服务获取实际的签名URL。可以在Service层添加：
```java
// 批量获取头像URL
List<String> fileIds = rankings.stream()
    .map(AwardRankVO::getAvatarUrl)
    .filter(Objects::nonNull)
    .collect(Collectors.toList());
    
Map<String, String> urlMap = mediaFeignClient.batchGetUrls(fileIds);

rankings.forEach(rank -> {
    if (rank.getAvatarUrl() != null) {
        rank.setAvatarUrl(urlMap.get(rank.getAvatarUrl()));
    }
});
```

### 3. 性能优化建议
- 对于访问频繁的统计接口，建议添加Redis缓存（TTL 5-10分钟）
- 为常用查询字段添加数据库索引：
  - `user.created_at`
  - `user.status`
  - `membership.lifecycle_status`
  - `user_award.awarded_at`
  - `user_award.award_level_id`
  - `user_award.award_type_id`

### 4. 获奖排行榜的团队获奖处理
当前SQL使用 `FIND_IN_SET` 来解析 `team_members` JSON数组。如果性能不佳，可以考虑：
- 创建一个中间表 `user_award_member` 来存储用户和获奖的多对多关系
- 在插入/更新获奖记录时同步维护这个中间表

### 5. 年级推算逻辑
当前假设学号前4位是入学年份（如：20240101001）。如果学号格式不同，需要修改 `StatisticsMapper.xml` 中的年级提取逻辑。

## 后续扩展

可以考虑添加：
1. 导出统计报表功能（Excel/PDF）
2. 自定义时间范围查询
3. 按部门筛选的获奖统计
4. 数据对比功能（同比、环比）
5. 统计数据缓存机制

## 文件清单

```
siae/services/siae-user/
├── docs/
│   ├── 统计接口设计.md          # 接口设计文档
│   └── 统计接口实现说明.md      # 本文件
├── src/main/java/com/hngy/siae/user/
│   ├── controller/
│   │   └── StatisticsController.java
│   ├── service/
│   │   ├── StatisticsService.java
│   │   └── impl/
│   │       └── StatisticsServiceImpl.java
│   ├── mapper/
│   │   └── StatisticsMapper.java
│   └── dto/response/statistics/
│       ├── MemberOverviewVO.java
│       ├── DepartmentStatVO.java
│       ├── AwardOverviewVO.java
│       ├── AwardDistributionVO.java
│       ├── TrendVO.java
│       ├── AwardRankVO.java
│       ├── GenderStatVO.java
│       ├── GradeStatVO.java
│       ├── MajorStatVO.java
│       ├── PositionStatVO.java
│       └── MembershipTrendVO.java
└── src/main/resources/mapper/
    └── StatisticsMapper.xml
```
