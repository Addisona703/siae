# siae-user 模块权限配置说明

## 权限设计原则

### 角色层级
1. **ROLE_ROOT（超级管理员）** - 默认放行所有接口，无需在权限表达式中声明
2. **ROLE_ADMIN（管理员）** - 拥有大部分管理权限
3. **ROLE_MEMBER（协会成员）** - 拥有内容相关权限和用户基础权限
4. **ROLE_USER（普通用户）** - 拥有基础查看和交互权限

### 权限配置策略

#### 1. 字典数据接口
- **创建/更新/删除** → 需要特定权限（如 `user:award-level:create`）
- **查询（GET）** → 所有已认证用户可访问（`RoleConstants.ANY_AUTHENTICATED`）

#### 2. 成员管理接口
- **申请成为候选成员** → 成员级别（`RoleConstants.MEMBER_LEVEL`）
- **候选成员转正** → 管理员级别（`RoleConstants.ADMIN_LEVEL`）
- **更新/删除成员** → 管理员级别
- **查询成员信息** → 成员级别
- **检查成员身份** → 管理员级别

#### 3. 用户获奖记录
- **创建/更新/查询** → 成员级别 + 特定权限（使用 `withAuthority`）
- **删除** → 管理员级别 + 特定权限

#### 4. 用户管理
- **创建用户** → 需要 `user:create` 权限
- **更新用户** → 管理员级别 + `user:update` 权限
- **查询用户** → 所有已认证用户
- **删除用户** → 需要 `user:delete` 权限

#### 5. Feign 接口
- **服务间调用** → 无权限控制（内部调用）

---

## 权限注解使用示例

### 1. 单个角色级别
```java
// 所有已认证用户
@SiaeAuthorize(RoleConstants.ANY_AUTHENTICATED)

// 成员级别（管理员或成员）
@SiaeAuthorize(RoleConstants.MEMBER_LEVEL)

// 管理员级别
@SiaeAuthorize(RoleConstants.ADMIN_LEVEL)
```

### 2. 单个权限
```java
@SiaeAuthorize("hasAuthority('user:award-level:create')")
```

### 3. 角色 + 权限组合（字符串拼接）
```java
// 成员级别 且 拥有创建权限
@SiaeAuthorize(RoleConstants.MEMBER_LEVEL + " and hasAuthority('user:award:create')")

// 管理员级别 且 拥有删除权限
@SiaeAuthorize(RoleConstants.ADMIN_LEVEL + " and hasAuthority('user:award:delete')")
```

### 4. 复杂组合
```java
// 管理员 或者 (成员 且 拥有特定权限)
@SiaeAuthorize("hasRole('" + RoleConstants.ROLE_ADMIN + "') or (hasRole('" + RoleConstants.ROLE_MEMBER + "') and hasAuthority('user:award:create'))")
```

---

## 接口权限配置清单

### 字典管理接口

#### AwardLevelController - 奖项等级
| 接口 | 权限配置 |
|------|---------|
| POST /award-levels | `hasAuthority('user:award-level:create')` |
| PUT /award-levels/{id} | `hasAuthority('user:award-level:update')` |
| GET /award-levels/{id} | `RoleConstants.ANY_AUTHENTICATED` |
| GET /award-levels | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /award-levels/{id} | `hasAuthority('user:award-level:delete')` |

#### AwardTypeController - 奖项类型
| 接口 | 权限配置 |
|------|---------|
| POST /award-types | `hasAuthority('user:award-type:create')` |
| PUT /award-types/{id} | `hasAuthority('user:award-type:update')` |
| GET /award-types/{id} | `RoleConstants.ANY_AUTHENTICATED` |
| GET /award-types | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /award-types/{id} | `hasAuthority('user:award-type:delete')` |

#### DepartmentController - 部门
| 接口 | 权限配置 |
|------|---------|
| POST /departments | `hasAuthority('user:department:create')` |
| PUT /departments/{id} | `hasAuthority('user:department:update')` |
| GET /departments/{id} | `RoleConstants.ANY_AUTHENTICATED` |
| GET /departments | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /departments/{id} | `hasAuthority('user:department:delete')` |

#### MajorController - 专业
| 接口 | 权限配置 |
|------|---------|
| POST /majors | `hasAuthority('user:major:create')` |
| PUT /majors/{id} | `hasAuthority('user:major:update')` |
| GET /majors/{id} | `RoleConstants.ANY_AUTHENTICATED` |
| GET /majors | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /majors/{id} | `hasAuthority('user:major:delete')` |

#### PositionController - 职位
| 接口 | 权限配置 |
|------|---------|
| POST /positions | `hasAuthority('user:position:create')` |
| PUT /positions/{id} | `hasAuthority('user:position:update')` |
| GET /positions/{id} | `RoleConstants.ANY_AUTHENTICATED` |
| GET /positions | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /positions/{id} | `hasAuthority('user:position:delete')` |

---

### 业务接口

#### MembershipController - 成员管理
| 接口 | 权限配置 |
|------|---------|
| POST /memberships/apply | `RoleConstants.MEMBER_LEVEL` |
| PUT /memberships/{id}/promote | `RoleConstants.ADMIN_LEVEL` |
| PUT /memberships/{id} | `RoleConstants.ADMIN_LEVEL` |
| DELETE /memberships/{id} | `RoleConstants.ADMIN_LEVEL` |
| GET /memberships/{id} | `RoleConstants.MEMBER_LEVEL` |
| GET /memberships/by-user/{userId} | `RoleConstants.MEMBER_LEVEL` |
| GET /memberships/{id}/detail | `RoleConstants.MEMBER_LEVEL` |
| POST /memberships/page | `RoleConstants.MEMBER_LEVEL` |
| GET /memberships/check/{userId} | `RoleConstants.ADMIN_LEVEL` |
| GET /memberships/check/{userId}/candidate | `RoleConstants.ADMIN_LEVEL` |
| GET /memberships/check/{userId}/official | `RoleConstants.ADMIN_LEVEL` |

#### UserAwardController - 用户获奖记录
| 接口 | 权限配置 |
|------|---------|
| POST /awards | `MEMBER_LEVEL + " and hasAuthority('user:award:create')"` |
| PUT /awards/{id} | `MEMBER_LEVEL + " and hasAuthority('user:award:update')"` |
| GET /awards/{id} | `MEMBER_LEVEL + " and hasAuthority('user:award:view')"` |
| POST /awards/user/{userId}/page | `MEMBER_LEVEL + " and hasAuthority('user:award:list')"` |
| POST /awards/page | `MEMBER_LEVEL + " and hasAuthority('user:award:list')"` |
| DELETE /awards/{id} | `ADMIN_LEVEL + " and hasAuthority('user:award:delete')"` |

#### UserController - 用户管理
| 接口 | 权限配置 |
|------|---------|
| POST / | `hasAuthority('user:create')` |
| PUT /{id} | `ADMIN_LEVEL + " and hasAuthority('user:update')"` |
| GET / | `RoleConstants.ANY_AUTHENTICATED` |
| POST /page | `RoleConstants.ANY_AUTHENTICATED` |
| DELETE /{id} | `hasAuthority('user:delete')` |
| GET /check-student-id/{studentId} | 无（公开接口） |

#### UserFeignController - Feign接口
| 接口 | 权限配置 |
|------|---------|
| 所有接口 | 无（内部服务调用） |

---

## 权限常量定义

### RoleConstants（角色常量）
```java
// 基础角色
public static final String ROLE_ROOT = "ROLE_ROOT";
public static final String ROLE_ADMIN = "ROLE_ADMIN";
public static final String ROLE_MEMBER = "ROLE_MEMBER";
public static final String ROLE_USER = "ROLE_USER";

// 组合表达式
public static final String ADMIN_LEVEL = "hasRole('ROLE_ADMIN')";
public static final String MEMBER_LEVEL = "hasRole('ROLE_ADMIN') or hasRole('ROLE_MEMBER')";
public static final String ANY_AUTHENTICATED = "hasRole('ROLE_ADMIN') or hasRole('ROLE_MEMBER') or hasRole('ROLE_USER')";

// 辅助方法
public static String withAuthority(String roleLevel, String authority)
```

### UserPermissions（用户模块权限常量）
```java
// 用户基础权限
public static final String USER_CREATE = "user:create";
public static final String USER_UPDATE = "user:update";
public static final String USER_VIEW = "user:view";
public static final String USER_LIST = "user:list";
public static final String USER_DELETE = "user:delete";

// 获奖记录权限
public static final String USER_AWARD_CREATE = "user:award:create";
public static final String USER_AWARD_UPDATE = "user:award:update";
public static final String USER_AWARD_VIEW = "user:award:view";
public static final String USER_AWARD_LIST = "user:award:list";
public static final String USER_AWARD_DELETE = "user:award:delete";

// 字典权限（award-level, award-type, department, major, position）
// 格式：user:{dictionary}:{action}
```

---

## 注意事项

1. **超级管理员默认放行**：`ROLE_ROOT` 在框架层面自动放行，无需在权限表达式中声明
2. **权限粒度**：字典数据的增删改需要特定权限，查询接口对所有已认证用户开放
3. **组合权限**：优先使用 `withAuthority` 方法简化"角色+权限"的组合表达式
4. **内部调用**：Feign 接口无权限控制，依赖服务间认证机制
5. **公开接口**：如 `checkStudentIdExists` 等校验接口可以不设置权限，供注册等场景使用
