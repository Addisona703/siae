# User服务统计接口设计文档

## 概述

本文档定义了User服务的统计分析接口，用于展示成员、部门、获奖等维度的数据统计。

**服务职责划分：**
- **User服务**：负责用户基础信息统计（成员、部门、获奖、人口统计等）
- **Auth服务**：负责登录行为统计（活跃用户、登录趋势、在线用户等）

**Base URL**: `/api/v1/users/statistics`

---

## 接口列表

### 1. 成员概览统计

**接口**: `GET /overview`

**描述**: 获取成员总体概况数据

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalUsers": 156,           // 总用户数（未删除）
    "enabledUsers": 145,          // 启用用户数（status=1）
    "disabledUsers": 11,          // 禁用用户数（status=0）
    "formalMembers": 89,          // 正式成员数（lifecycleStatus=1）
    "candidateMembers": 56,       // 候选成员数（lifecycleStatus=0）
    "newUsersThisMonth": 12,      // 本月新增用户
    "newUsersThisYear": 45        // 本年新增用户
  }
}
```

**字段说明**:
- `totalUsers`: 所有未删除的用户总数
- `enabledUsers`: 账号状态为启用的用户数
- `disabledUsers`: 账号状态为禁用的用户数
- `formalMembers`: 已转正的正式成员数
- `candidateMembers`: 候选成员数
- `newUsersThisMonth`: 本月创建的用户数
- `newUsersThisYear`: 本年创建的用户数

---

### 2. 部门分布统计

**接口**: `GET /departments`

**描述**: 获取各部门的成员分布情况

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "departmentId": 1,
      "departmentName": "技术部",
      "totalMembers": 45,         // 该部门总人数
      "formalMembers": 30,        // 正式成员数
      "candidateMembers": 15,     // 候选成员数
      "withPosition": 8           // 有职位的人数
    },
    {
      "departmentId": 2,
      "departmentName": "运营部",
      "totalMembers": 32,
      "formalMembers": 20,
      "candidateMembers": 12,
      "withPosition": 5
    }
  ]
}
```

**字段说明**:
- `totalMembers`: 该部门的总成员数（包括正式和候选）
- `formalMembers`: 该部门的正式成员数
- `candidateMembers`: 该部门的候选成员数
- `withPosition`: 在该部门担任职位的人数（member_department.hasPosition=1）

---

### 3. 获奖统计总览

**接口**: `GET /awards/overview`

**描述**: 获取获奖情况的总体概况

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalAwards": 234,           // 总获奖数
    "thisYearAwards": 56,         // 本年获奖数
    "thisMonthAwards": 8,         // 本月获奖数
    "teamAwards": 89,             // 团队获奖数（teamMembers不为空）
    "individualAwards": 145       // 个人获奖数（teamMembers为空）
  }
}
```

**字段说明**:
- `totalAwards`: 所有未删除的获奖记录总数
- `thisYearAwards`: 本年度获奖数（awardedAt在本年）
- `thisMonthAwards`: 本月获奖数（awardedAt在本月）
- `teamAwards`: 团队获奖数（teamMembers字段不为空或不为"[]"）
- `individualAwards`: 个人获奖数（teamMembers字段为空或为"[]"）

---

### 4. 按奖项等级分布

**接口**: `GET /awards/by-level`

**描述**: 获取按奖项等级分组的获奖统计

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "levelId": 1,
      "levelName": "国家级",
      "count": 23
    },
    {
      "levelId": 2,
      "levelName": "省级",
      "count": 67
    },
    {
      "levelId": 3,
      "levelName": "校级",
      "count": 144
    }
  ]
}
```

**字段说明**:
- `levelId`: 奖项等级ID
- `levelName`: 奖项等级名称
- `count`: 该等级的获奖数量

---

### 5. 按奖项类型分布

**接口**: `GET /awards/by-type`

**描述**: 获取按奖项类型分组的获奖统计

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "typeId": 1,
      "typeName": "学科竞赛",
      "count": 89
    },
    {
      "typeId": 2,
      "typeName": "科研论文",
      "count": 45
    },
    {
      "typeId": 3,
      "typeName": "专利软著",
      "count": 34
    }
  ]
}
```

**字段说明**:
- `typeId`: 奖项类型ID
- `typeName`: 奖项类型名称
- `count`: 该类型的获奖数量

---

### 6. 获奖趋势

**接口**: `GET /awards/trend`

**描述**: 获取获奖数量的时间趋势

**权限**: 需要登录

**请求参数**:
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| period | string | 否 | month | 统计周期：`month`(按月) 或 `year`(按年) |
| limit | integer | 否 | 12 | 返回最近N个周期的数据 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "period": "2024-01",        // 时间段（按月：YYYY-MM，按年：YYYY）
      "count": 12                 // 该时间段的获奖数量
    },
    {
      "period": "2024-02",
      "count": 15
    },
    {
      "period": "2024-03",
      "count": 18
    }
    // ... 最近12个月
  ]
}
```

**字段说明**:
- `period`: 时间段标识（按月：YYYY-MM格式，按年：YYYY格式）
- `count`: 该时间段内的获奖数量

---

### 7. 获奖排行榜

**接口**: `GET /awards/top`

**描述**: 获取获奖最多的成员排行榜

**权限**: 需要登录

**请求参数**:
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| limit | integer | 否 | 10 | 返回TOP N，最大100 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "userId": 123,
      "username": "zhangsan",
      "realName": "张三",
      "avatarUrl": "https://cdn.example.com/avatar/123.jpg",
      "awardCount": 15,           // 获奖总数
      "nationalCount": 3,         // 国家级获奖数
      "provincialCount": 5,       // 省级获奖数
      "schoolCount": 7            // 校级获奖数
    },
    {
      "userId": 456,
      "username": "lisi",
      "realName": "李四",
      "avatarUrl": "https://cdn.example.com/avatar/456.jpg",
      "awardCount": 12,
      "nationalCount": 2,
      "provincialCount": 4,
      "schoolCount": 6
    }
    // ... TOP 10
  ]
}
```

**字段说明**:
- `userId`: 用户ID
- `username`: 用户名
- `realName`: 真实姓名
- `avatarUrl`: 头像URL（通过avatarFileId获取）
- `awardCount`: 该用户的总获奖数
- `nationalCount`: 国家级获奖数（需要关联award_level表判断）
- `provincialCount`: 省级获奖数
- `schoolCount`: 校级获奖数

**注意**: 
- 团队获奖会计入所有团队成员的获奖数
- 需要解析user_award.teamMembers字段（JSON数组）

---

### 8. 性别分布

**接口**: `GET /demographics/gender`

**描述**: 获取成员的性别分布统计

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "gender": 1,                // 1男 2女 0未知
      "genderName": "男",
      "count": 89,
      "percentage": 57.05
    },
    {
      "gender": 2,
      "genderName": "女",
      "count": 65,
      "percentage": 41.67
    },
    {
      "gender": 0,
      "genderName": "未知",
      "count": 2,
      "percentage": 1.28
    }
  ]
}
```

**字段说明**:
- `gender`: 性别代码（0未知，1男，2女）
- `genderName`: 性别名称
- `count`: 该性别的人数
- `percentage`: 占比百分比（保留2位小数）

**数据来源**: user_profile.gender

---

### 9. 年级分布

**接口**: `GET /demographics/grade`

**描述**: 获取成员的年级分布统计

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "grade": "2024级",
      "count": 45
    },
    {
      "grade": "2023级",
      "count": 38
    },
    {
      "grade": "2022级",
      "count": 32
    },
    {
      "grade": "2021级",
      "count": 28
    },
    {
      "grade": "其他",
      "count": 13
    }
  ]
}
```

**字段说明**:
- `grade`: 年级标识（如"2024级"）
- `count`: 该年级的人数

**数据来源**: 
- 从user.studentId字段提取年级（假设学号前4位是入学年份）
- 无法识别的归入"其他"

---

### 10. 专业分布

**接口**: `GET /demographics/major`

**描述**: 获取成员的专业分布统计

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "majorId": 1,
      "majorName": "计算机科学与技术",
      "count": 56
    },
    {
      "majorId": 2,
      "majorName": "软件工程",
      "count": 43
    },
    {
      "majorId": 3,
      "majorName": "网络工程",
      "count": 28
    }
  ]
}
```

**字段说明**:
- `majorId`: 专业ID
- `majorName`: 专业名称
- `count`: 该专业的人数

**数据来源**: 
- 关联major_class_enrollment表和major表
- 统计每个专业的用户数

---

### 11. 职位分布

**接口**: `GET /positions`

**描述**: 获取各职位的人数分布

**权限**: 需要登录

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "positionId": 1,
      "positionName": "会长",
      "count": 1
    },
    {
      "positionId": 2,
      "positionName": "副会长",
      "count": 2
    },
    {
      "positionId": 3,
      "positionName": "部长",
      "count": 6
    },
    {
      "positionId": 4,
      "positionName": "副部长",
      "count": 8
    }
  ]
}
```

**字段说明**:
- `positionId`: 职位ID
- `positionName`: 职位名称
- `count`: 担任该职位的人数

**数据来源**: 
- 关联member_position表和position表
- 统计每个职位的人数

---

### 12. 入会趋势

**接口**: `GET /membership/trend`

**描述**: 获取成员入会和转正的时间趋势

**权限**: 需要登录

**请求参数**:
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| period | string | 否 | month | 统计周期：`month`(按月) 或 `year`(按年) |
| limit | integer | 否 | 12 | 返回最近N个周期的数据 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "period": "2024-01",
      "formalCount": 5,           // 转正人数（joinDate在该月）
      "candidateCount": 12        // 新增候选人数（createdAt在该月且lifecycleStatus=0）
    },
    {
      "period": "2024-02",
      "formalCount": 8,
      "candidateCount": 15
    },
    {
      "period": "2024-03",
      "formalCount": 6,
      "candidateCount": 10
    }
    // ... 最近12个月
  ]
}
```

**字段说明**:
- `period`: 时间段标识（按月：YYYY-MM格式，按年：YYYY格式）
- `formalCount`: 该时间段内转正的人数（membership.joinDate在该时间段）
- `candidateCount`: 该时间段内新增的候选成员数（membership.createdAt在该时间段且lifecycleStatus=0）

---

## 数据库表关系

### 涉及的主要表

1. **user** - 用户主表
   - id, username, studentId, avatarFileId, status, createdAt

2. **user_profile** - 用户详情表
   - userId, realName, gender, birthday

3. **membership** - 成员表
   - userId, lifecycleStatus, joinDate, createdAt

4. **member_department** - 成员部门关联表
   - membershipId, departmentId, hasPosition

5. **member_position** - 成员职位关联表
   - membershipId, positionId

6. **department** - 部门字典表
   - id, name

7. **position** - 职位字典表
   - id, name

8. **user_award** - 用户获奖表
   - awardTitle, awardLevelId, awardTypeId, awardedAt, teamMembers

9. **award_level** - 奖项等级字典表
   - id, name

10. **award_type** - 奖项类型字典表
    - id, name

11. **major** - 专业字典表
    - id, name

12. **major_class_enrollment** - 专业班级注册表
    - userId, majorId

---

## 实现注意事项

### 1. 性能优化
- 所有统计查询应该使用数据库聚合函数（COUNT, GROUP BY等）
- 避免在应用层进行大量数据的循环计算
- 考虑为常用查询字段添加索引（如createdAt, awardedAt, lifecycleStatus等）
- 对于复杂统计，可以考虑使用Redis缓存结果（TTL设置为5-10分钟）

### 2. 数据一致性
- 所有查询都应该排除已删除的记录（isDeleted=0或1）
- 时间范围查询统一使用服务器时区
- 百分比计算保留2位小数

### 3. 权限控制
- 所有统计接口都需要登录
- 敏感统计数据（如个人详细信息）可能需要管理员权限
- 使用`@SiaeAuthorize`注解进行权限控制

### 4. 团队获奖处理
- user_award.teamMembers字段存储JSON数组格式：`[1,2,3,5]`
- 需要解析该字段来判断是否为团队获奖
- 计算个人获奖数时，需要将团队获奖分配给所有成员

### 5. 年级推算逻辑
```java
// 从学号提取年级（假设学号格式：20240101001）
String studentId = "20240101001";
String year = studentId.substring(0, 4);  // "2024"
String grade = year + "级";  // "2024级"
```

### 6. 头像URL获取
- avatarFileId需要调用Media服务获取签名URL
- 可以批量调用Media服务的批量签名接口提高性能
- 如果Media服务不可用，返回默认头像URL

---

## 错误码

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 401 | 未登录 |
| 403 | 权限不足 |
| 400 | 参数错误（如limit超出范围） |
| 500 | 服务器内部错误 |

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-11-17 | 初始版本，定义12个统计接口 |

---

## 后续扩展

可能的扩展方向：
1. 导出统计报表（Excel/PDF）
2. 自定义时间范围查询
3. 更细粒度的筛选条件（如按部门筛选获奖统计）
4. 数据对比功能（同比、环比）
5. 实时数据推送（WebSocket）
