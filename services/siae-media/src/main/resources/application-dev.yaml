# ===================================================================
# DEV CONFIGURATION (本地开发配置)
# ===================================================================

server:
  port: 8040
  servlet:
    context-path: /api/v1/media

spring:
  # 禁用 Nacos
  cloud:
    nacos:
      discovery:
        enabled: true
      config:
        enabled: false  
  
  # 排除 Spring Security 自动配置（开发环境）
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration
      - org.springframework.boot.actuate.autoconfigure.security.servlet.ManagementWebSecurityAutoConfiguration
  
  # 数据库配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/media_db?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false
    username: root
    password: 123456
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # 连接池配置
      initial-size: 1
      min-idle: 1
      max-active: 3
      max-wait: 60000
      test-while-idle: true
      validation-query: SELECT 1
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      # 监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        login-username: admin
        login-password: admin
        reset-enable: false
      # Web监控
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"
      # SQL监控
      filter:
        stat:
          enabled: true
          log-slow-sql: true
          slow-sql-millis: 2000
        wall:
          enabled: true
          config:
            multi-statement-allow: true

  # 2.3 Redis 配置
  data:
    redis:
      host: localhost
      port: 6379
      password: 123456
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  # 2.4 RabbitMQ 消息队列配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    virtual-host: /
    listener:
      simple:
        acknowledge-mode: manual
        prefetch: 1
        retry:
          enabled: true
          max-attempts: 3

  # 2.5 Jackson JSON序列化配置
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    default-property-inclusion: non_null

  # 2.6 生命周期配置
  lifecycle:
    timeout-per-shutdown-phase: 30s

# 3. MyBatis Plus 配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: assign_uuid
      logic-delete-field: deletedAt
      logic-delete-value: NOW()
      logic-not-delete-value: "NULL"
  type-aliases-package: com.hngy.siae.media.domain.entity

# 4. MinIO 对象存储配置
# 对应配置类: com.hngy.siae.media.config.MinioConfig
# 注意：endpoint 应该是 MinIO 的 API 端口，根据你的启动命令是 9000
# 控制台地址是 http://localhost:9001
minio:
  # 注意：endpoint必须和前端访问MinIO时使用的地址一致，否则签名验证会失败
  # 本地开发：使用localhost（仅本机访问）
  # 局域网访问：使用IP地址（需要确保MinIO也监听该IP）
  endpoint: http://8.134.251.36:9000
  accessKey: root
  secretKey: 123456789
  bucketName: siae-media
  region: us-east-1
  # 外部访问地址（用于替换生成的URL中的endpoint，供前端访问）
  # 如果不配置，则使用 endpoint 的值
#  external-endpoint: http://192.168.155.13:9000

# 5. 媒体业务配置
media:
  upload:
    max-file-size: 524288000         # 500 MB (单个文件最大大小，不启用分片时的限制)
    max-multipart-size: 2147483648   # 2 GB (分片上传总大小限制)
    multipart-threshold: 10485760    # 10 MB (超过此大小启用分片上传)
    default-part-size: 10485760     # 10 MB (默认分片大小)
    session-expiry: 86400           # 24 小时 (上传会话过期时间，单位：秒)
    presigned-url-expiry: 900       # 15 分钟 (预签名URL过期时间，单位：秒)
    allowed-mime-types:
      - image/jpeg
      - image/png
      - image/gif
      - image/webp
      - image/svg+xml
      - image/heic
      - image/heif
      - application/pdf
      - text/plain
      - text/markdown
      - text/csv
      - application/msword
      - application/vnd.openxmlformats-officedocument.wordprocessingml.document
      - application/vnd.ms-excel
      - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
      - application/vnd.ms-powerpoint
      - application/vnd.openxmlformats-officedocument.presentationml.presentation
      - application/vnd.oasis.opendocument.text
      - application/vnd.oasis.opendocument.spreadsheet
      - application/vnd.oasis.opendocument.presentation
      - application/rtf
      - application/json
      - application/xml
      - video/mp4
      - video/quicktime
      - video/x-msvideo
      - video/x-matroska
      - audio/mpeg
      - audio/aac
      - audio/flac
      - audio/wav
      - audio/ogg
  download:
    presigned-url-expiry: 900       # 15 分钟 (下载预签名URL过期时间，单位：秒)
  quota:
    default-max-bytes: 10737418240  # 10 GB (默认存储配额)
    default-max-objects: 5000       # 默认对象数量限制
  cdn:
    enabled: false                  # 是否启用CDN
    base-url: https://cdn.example.com  # CDN基础URL（可选）
  url:
    public-ttl: 604800              # 7 天 (公开文件URL缓存时间，单位：秒)
    private-ttl: 82800              # 23 小时 (私有文件URL缓存时间，单位：秒)
    expiration: 86400               # 24 小时 (URL默认过期时间，单位：秒)
    cache-enabled: true             # 启用URL缓存

# 5. SpringDoc API文档配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  group-configs:
    - group: 'siae-media'
      paths-to-match: '/api/**'
  packages-to-scan: com.hngy.siae.media.controller

# 6. Actuator 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,loggers
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      environment: dev
  tracing:
    enabled: false
    sampling:
      probability: 1.0
  prometheus:
    metrics:
      export:
        enabled: true

# SIAE 安全配置
siae:
  auth:
    enable-gateway-auth: false
    enable-direct-access: true
  security:
    enabled: false

# 日志配置
logging:
  level:
    root: INFO
    com.hngy.siae.media: DEBUG
