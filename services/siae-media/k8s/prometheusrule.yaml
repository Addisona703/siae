apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: siae-media-alerts
  namespace: siae
  labels:
    app: siae-media
    release: prometheus
spec:
  groups:
    - name: siae-media.rules
      interval: 30s
      rules:
        # 服务可用性告警
        - alert: MediaServiceDown
          expr: up{job="siae-media"} == 0
          for: 1m
          labels:
            severity: critical
            service: siae-media
          annotations:
            summary: "Media Service is down"
            description: "Media Service {{ $labels.instance }} has been down for more than 1 minute."
        
        # 高错误率告警
        - alert: MediaServiceHighErrorRate
          expr: |
            rate(http_server_requests_seconds_count{job="siae-media",status=~"5.."}[5m]) 
            / 
            rate(http_server_requests_seconds_count{job="siae-media"}[5m]) 
            > 0.05
          for: 5m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High error rate in Media Service"
            description: "Media Service error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
        
        # 响应时间告警
        - alert: MediaServiceHighLatency
          expr: |
            histogram_quantile(0.95, 
              rate(http_server_requests_seconds_bucket{job="siae-media"}[5m])
            ) > 2
          for: 5m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High latency in Media Service"
            description: "Media Service P95 latency is {{ $value }}s (threshold: 2s)"
        
        # CPU 使用率告警
        - alert: MediaServiceHighCPU
          expr: |
            rate(process_cpu_seconds_total{job="siae-media"}[5m]) * 100 > 80
          for: 10m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High CPU usage in Media Service"
            description: "Media Service CPU usage is {{ $value | humanize }}% (threshold: 80%)"
        
        # 内存使用率告警
        - alert: MediaServiceHighMemory
          expr: |
            (jvm_memory_used_bytes{job="siae-media",area="heap"} 
            / 
            jvm_memory_max_bytes{job="siae-media",area="heap"}) * 100 > 85
          for: 10m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High memory usage in Media Service"
            description: "Media Service memory usage is {{ $value | humanize }}% (threshold: 85%)"
        
        # 文件上传失败率告警
        - alert: MediaServiceHighUploadFailureRate
          expr: |
            rate(media_file_upload_failure_total{job="siae-media"}[5m]) 
            / 
            rate(media_file_upload_total{job="siae-media"}[5m]) 
            > 0.1
          for: 5m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High upload failure rate"
            description: "Upload failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"
        
        # 配额超限告警
        - alert: MediaServiceQuotaExceeded
          expr: |
            increase(media_quota_exceeded_total{job="siae-media"}[5m]) > 10
          for: 5m
          labels:
            severity: info
            service: siae-media
          annotations:
            summary: "Quota exceeded events detected"
            description: "{{ $value }} quota exceeded events in the last 5 minutes"
        
        # RabbitMQ 队列堆积告警
        - alert: MediaServiceRabbitMQQueueBacklog
          expr: |
            rabbitmq_queue_messages{job="siae-media"} > 1000
          for: 10m
          labels:
            severity: warning
            service: siae-media
          annotations:
            summary: "High RabbitMQ queue backlog"
            description: "RabbitMQ queue {{ $labels.queue }} has {{ $value }} messages (threshold: 1000)"
        
        # 存储服务不可用告警
        - alert: MediaServiceStorageDown
          expr: |
            health_component_status{job="siae-media",component="storage"} == 0
          for: 2m
          labels:
            severity: critical
            service: siae-media
          annotations:
            summary: "Storage service is down"
            description: "MinIO storage service is not available"
