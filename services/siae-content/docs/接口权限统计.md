# siae-content 模块接口权限配置

> 注：超级管理员（ROLE_ROOT）默认放行所有接口，无需在权限表达式中声明

---

## ContentController - 内容管理

- **publishContent** - 发布内容  
  权限：`hasAuthority('content:publish')` + 所有认证用户

- **editContent** - 编辑内容  
  权限：`hasAuthority('content:edit')` + 所有认证用户

- **deleteContent** - 删除内容  
  权限：`hasAuthority('content:delete')` + 如果不是管理员，则只能删除自己创建的内容

- **queryContent** - 查询内容详情  
  权限：`hasAuthority('content:query')`  + 所有认证用户

- **queryContentList** - 查询内容列表  
  权限：`hasAuthority('content:list:view')` + 所有认证用户

- **queryHotContent** - 查询热门内容
  权限：无（公开接口）

---

## CategoriesController - 分类管理

- **createCategory** - 创建分类  
  权限：`hasAuthority('content:category:create')` 

- **updateCategory** - 更新分类  
  权限：`hasAuthority('content:category:edit')`

- **deleteCategory** - 删除分类  
  权限：`hasAuthority('content:category:delete')`

- **listCategories** - 分页查询分类列表  
  权限：`hasAuthority('content:category:view')` + 所有认证用户

- **queryCategory** - 查询分类详情  
  权限：`hasAuthority('content:category:view')` + 所有认证用户

- **updateStatus** - 启用/禁用分类  
  权限：`hasAuthority('content:category:toggle')` 

---

## TagsController - 标签管理

- **createTag** - 创建标签  
  权限：`hasAuthority('content:tag:create')`

- **updateTag** - 更新标签  
  权限：`hasAuthority('content:tag:edit')`

- **deleteTag** - 删除标签  
  权限：`hasAuthority('content:tag:delete')`

- **listTags** - 分页查询标签列表  
  权限：`hasAuthority('content:tag:view')` + 所有认证用户

---

## CommentsController - 评论管理

- **createComment** - 创建评论 + 所有认证用户


- **updateComment** - 更新评论 + 所有认证用户  


- **deleteComment** - 删除评论 + 如果不是管理员，则只能删除自己创建的评论，但是内容的创建者可以删除他内容下的评论

- **listComments** - 查询评论列表（按内容ID）  + 所有认证用户 


- **listCommentsPage** - 分页查询评论（标准化分页）   + 所有认证用户


---

## AuditsController - 审核管理

- **handleAudit** - 处理审核  
  权限：`hasAuthority('content:audit:handle')` + 所有管理员

- **getAuditPage** - 获取审核列表  
  权限：`hasAuthority('content:audit:view')`+ 所有管理员

- **getAuditRecord** - 获取审核记录  
  权限：`hasAuthority('content:audit:view')`  + 如果不是管理员，则只能查看自己的审核记录

---

## FavoritesController - 收藏管理

### 收藏夹管理

- **createFolder** - 创建收藏夹  
  权限：`hasAuthority('content:favorite:manage')` + 所有认证用户

- **updateFolder** - 更新收藏夹  
  权限：`hasAuthority('content:favorite:manage')` + 所有认证用户非管理员只能更新自己的

- **deleteFolder** - 删除收藏夹  
  权限：`hasAuthority('content:favorite:manage')` + 所有认证用户非管理员只能更新自己的

- **getUserFolders** - 查询收藏夹列表  
  权限：`hasAuthority('content:favorite:view')` + 所有认证用户

- **getFolderDetail** - 查询收藏夹详情  
  权限：`hasAuthority('content:favorite:view')` + 所有认证用户

### 收藏内容管理

- **addFavorite** - 添加收藏  
  权限：`hasAuthority('content:favorite:add')` + 所有认证用户

- **updateFavorite** - 更新收藏  
  权限：`hasAuthority('content:favorite:manage')` + 所有认证用户非管理员只能更新自己的

- **removeFavorite** - 取消收藏  
  权限：`hasAuthority('content:favorite:remove')` + 所有认证用户

- **getFolderItems** - 查询收藏夹中的内容列表  
  权限：`hasAuthority('content:favorite:view')` + 所有认证用户

- **getUserFavorites** - 查询用户所有收藏  
  权限：`hasAuthority('content:favorite:view')` + 所有认证用户

- **checkFavorite** - 检查是否已收藏  
  权限：`hasAuthority('content:favorite:view')` + 所有认证用户

---

## InteractionsController - 用户交互

- **recordAction** - 记录用户行为  
  权限：`hasAuthority('content:interaction:record')` + 所有认证用户（可以点赞、浏览等）

- **cancelAction** - 取消用户行为  
  权限：`hasAuthority('content:interaction:cancel')` + 所有认证用户（可以取消点赞等）

---

## StatisticsController - 统计管理

- **getStatistics** - 获取内容统计信息  
  权限：`hasAuthority('content:statistics:view')` + 所有认证用户

- **updateStatistics** - 更新内容统计信息  
  权限：`hasAuthority('content:statistics:update')`

---

## 权限常量说明

### 内容权限
- `content:publish` - 发布内容
- `content:edit` - 编辑内容
- `content:delete` - 删除内容
- `content:query` - 查询内容详情
- `content:list:view` - 查看内容列表

### 分类权限
- `content:category:create` - 创建分类
- `content:category:edit` - 编辑分类
- `content:category:delete` - 删除分类
- `content:category:view` - 查看分类
- `content:category:toggle` - 启用/禁用分类

### 标签权限
- `content:tag:create` - 创建标签
- `content:tag:edit` - 编辑标签
- `content:tag:delete` - 删除标签
- `content:tag:view` - 查看标签

### 审核权限
- `content:audit:handle` - 处理审核
- `content:audit:view` - 查看审核

### 收藏权限
- `content:favorite:add` - 添加收藏
- `content:favorite:remove` - 取消收藏
- `content:favorite:manage` - 管理收藏夹
- `content:favorite:view` - 查看收藏

### 交互权限
- `content:interaction:record` - 记录交互行为
- `content:interaction:cancel` - 取消交互行为

### 统计权限
- `content:statistics:view` - 查看统计信息
- `content:statistics:update` - 更新统计信息

### 使用示例
```java
// 单个权限
@SiaeAuthorize("hasAuthority('content:publish')")
@SiaeAuthorize("hasAuthority('content:category:create')")

// 角色 + 权限组合（如需要）
@SiaeAuthorize(RoleConstants.MEMBER_LEVEL + " and hasAuthority('content:publish')")
@SiaeAuthorize(RoleConstants.ADMIN_LEVEL + " and hasAuthority('content:audit:handle')")
```

---

## 权限实现说明

### 控制器层权限（@SiaeAuthorize）
所有接口均已配置基础权限注解，通过 `hasAuthority()` 检查用户是否拥有对应的权限标识。

### 业务逻辑层权限控制
以下接口在业务逻辑层实现了额外的权限控制：

#### 1. 内容管理
- **deleteContent**：非管理员只能删除自己创建的内容
  - 实现位置：`ContentController.deleteContent()`
  - 权限检查：通过 Security 上下文获取当前用户ID和角色，验证是否为内容创建者或管理员

#### 2. 评论管理
- **updateComment**：非管理员只能更新自己创建的评论
  - 实现位置：`CommentsServiceImpl.updateComment()`
  - 权限检查：验证评论创建者ID与当前用户ID是否一致

- **deleteComment**：非管理员只能删除自己创建的评论或自己内容下的评论
  - 实现位置：`CommentFacadeImpl.deleteComment()`
  - 权限检查：验证是否为评论作者、内容创建者或管理员

#### 3. 审核管理
- **getAuditPage**：必须是管理员才能查看审核列表
  - 实现位置：`AuditsServiceImpl.getAuditPage()`
  - 权限检查：验证用户是否拥有 ROLE_ADMIN 或 ROLE_ROOT 角色

- **getAuditRecord**：非管理员只能查看自己的审核记录
  - 实现位置：`AuditsServiceImpl.getAuditRecord()`
  - 权限检查：根据目标类型获取创建者ID，验证是否为创建者或管理员

#### 4. 收藏管理
- **updateFolder**：非管理员只能更新自己的收藏夹
  - 实现位置：`FavoriteServiceImpl.updateFolder()`
  - 权限检查：验证收藏夹所有者ID与当前用户ID是否一致

- **deleteFolder**：非管理员只能删除自己的收藏夹
  - 实现位置：`FavoriteServiceImpl.deleteFolder()`
  - 权限检查：验证收藏夹所有者ID与当前用户ID是否一致

- **updateFavorite**：非管理员只能更新自己的收藏
  - 实现位置：`FavoriteServiceImpl.updateFavorite()`
  - 权限检查：验证收藏所有者ID与当前用户ID是否一致

### 权限检查实现方式
```java
// 从Security上下文获取当前用户信息
Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

// 获取用户ID（从Details中获取）
Long currentUserId = (Long) authentication.getDetails();

// 判断是否为管理员
boolean isAdmin = authentication.getAuthorities().stream()
    .anyMatch(auth -> auth.getAuthority().equals("ROLE_ADMIN") || 
                      auth.getAuthority().equals("ROLE_ROOT"));

// 权限检查
if (!isAdmin) {
    AssertUtils.isTrue(resourceOwnerId.equals(currentUserId), 
        ContentResultCodeEnum.NO_PERMISSION);
}
```

## 注意事项

1. **热门内容**：`queryHotContent` 接口为公开接口，任何用户都可以访问，无需认证。

2. **超级管理员**：拥有 `ROLE_ROOT` 角色的用户默认放行所有接口，拥有所有权限。

3. **权限粒度**：
   - 控制器层通过 `@SiaeAuthorize` 注解进行粗粒度权限控制
   - 业务逻辑层通过代码实现细粒度权限控制（如所有者验证）
   - 两层权限控制相结合，确保系统安全性

4. **错误码**：所有权限相关的错误都有对应的错误码，便于前端处理和用户提示
