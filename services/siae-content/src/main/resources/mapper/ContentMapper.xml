<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hngy.siae.content.mapper.ContentMapper">

    <!-- 内容详情扩展结果映射 -->
    <resultMap id="ContentDetailResultMap" type="com.hngy.siae.content.dto.response.content.ContentQueryResultVO">
        <!-- 内容基本信息 -->
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="type" column="type"/>
        <result property="description" column="description"/>
        <result property="coverFileId" column="cover_file_id"/>
        <result property="uploadedBy" column="uploaded_by"/>
        <result property="categoryId" column="category_id"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        
        <!-- 分类名称 -->
        <result property="categoryName" column="category_name"/>
        
        <!-- 统计信息 -->
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="commentCount" column="comment_count"/>
        
        <!-- 标签ID列表（使用逗号分隔的字符串，需要在Service层转换） -->
        <result property="tagIdsStr" column="tag_ids"/>
        
        <!-- 标签名称列表（使用逗号分隔的字符串，需要在Service层转换） -->
        <result property="tagNamesStr" column="tag_names"/>
    </resultMap>

    <!-- 查询内容详情（包含分类、标签、统计信息） -->
    <select id="selectContentDetailById" resultMap="ContentDetailResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            c.cover_file_id,
            c.uploaded_by,
            c.category_id,
            c.status,
            c.create_time,
            c.update_time,
            cat.name as category_name,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            COALESCE(s.favorite_count, 0) as favorite_count,
            COALESCE(s.comment_count, 0) as comment_count,
            GROUP_CONCAT(DISTINCT t.id) as tag_ids,
            GROUP_CONCAT(DISTINCT t.name) as tag_names
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        LEFT JOIN tag_relation ctr ON c.id = ctr.content_id
        LEFT JOIN tag t ON ctr.tag_id = t.id
        WHERE c.id = #{contentId}
        AND c.status != 3
        GROUP BY c.id
    </select>

    <!-- 内容分页查询结果映射 -->
    <resultMap id="ContentPageResultMap" type="com.hngy.siae.content.dto.response.content.ContentVO">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="type" column="type"/>
        <result property="description" column="description"/>
        <result property="coverFileId" column="cover_file_id"/>
        <result property="uploadedBy" column="uploaded_by"/>
        <result property="categoryName" column="category_name"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <!-- 统计信息嵌套对象 -->
        <association property="statistics" javaType="com.hngy.siae.content.dto.response.statistics.StatisticsVO">
            <result property="contentId" column="content_id"/>
            <result property="viewCount" column="view_count"/>
            <result property="likeCount" column="like_count"/>
            <result property="favoriteCount" column="favorite_count"/>
            <result property="commentCount" column="comment_count"/>
        </association>
    </resultMap>

    <!-- 分页查询内容列表（联表查询分类名称和统计信息） -->
    <select id="selectContentPageWithDetails" resultMap="ContentPageResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            c.cover_file_id,
            c.uploaded_by,
            cat.name as category_name,
            c.status,
            c.create_time,
            c.update_time,
            s.content_id,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            COALESCE(s.favorite_count, 0) as favorite_count,
            COALESCE(s.comment_count, 0) as comment_count
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        <where>
            <if test="content.id != null">
                AND c.id = #{content.id}
            </if>
            <if test="content.categoryId != null">
                AND c.category_id = #{content.categoryId}
            </if>
            <if test="content.status != null">
                AND c.status = #{content.status}
            </if>
            <if test="content.type != null">
                AND c.type = #{content.type}
            </if>
        </where>
        ORDER BY c.create_time DESC
    </select>

    <!-- 分页查询内容列表（已发布的内容 + 当前用户的草稿和待审核） -->
    <select id="selectContentPageByQuery" resultMap="ContentPageResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            c.cover_file_id,
            c.uploaded_by,
            cat.name as category_name,
            c.status,
            c.create_time,
            c.update_time,
            s.content_id,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            COALESCE(s.favorite_count, 0) as favorite_count,
            COALESCE(s.comment_count, 0) as comment_count
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        <if test="query.tagIds != null and query.tagIds.size() > 0">
            INNER JOIN tag_relation ctr ON c.id = ctr.content_id
            AND ctr.tag_id IN
            <foreach collection="query.tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
        </if>
        <where>
            <choose>
                <!-- 如果指定了草稿或待审核状态，只查询当前用户的内容 -->
                <when test="query.status != null and (query.status.code == 0 or query.status.code == 1)">
                    AND c.status = #{query.status}
                    AND c.uploaded_by = #{currentUserId}
                </when>
                <!-- 如果指定了已发布状态，只查询已发布的内容 -->
                <when test="query.status != null and query.status.code == 2">
                    AND c.status = 2
                </when>
                <!-- 如果没有指定状态，查询已发布的内容 + 当前用户的草稿和待审核 -->
                <otherwise>
                    AND (
                        c.status = 2
                        OR (c.status IN (0, 1) AND c.uploaded_by = #{currentUserId})
                    )
                </otherwise>
            </choose>
            <if test="query.categoryId != null">
                AND c.category_id = #{query.categoryId}
            </if>
            <if test="query.uploadedBy != null">
                AND c.uploaded_by = #{query.uploadedBy}
            </if>
            <if test="query.type != null">
                AND c.type = #{query.type}
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND (c.title LIKE CONCAT('%', #{query.keyword}, '%')
                OR c.description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
        GROUP BY c.id
        ORDER BY c.create_time DESC
    </select>

    <!-- 管理员分页查询待审核内容（不包括草稿） -->
    <select id="selectPendingContentPage" resultMap="ContentPageResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            c.cover_file_id,
            c.uploaded_by,
            cat.name as category_name,
            c.status,
            c.create_time,
            c.update_time,
            s.content_id,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            COALESCE(s.favorite_count, 0) as favorite_count,
            COALESCE(s.comment_count, 0) as comment_count
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        <if test="query.tagIds != null and query.tagIds.size() > 0">
            INNER JOIN tag_relation ctr ON c.id = ctr.content_id
            AND ctr.tag_id IN
            <foreach collection="query.tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
        </if>
        <where>
            <!-- 只查询待审核状态（不包括草稿） -->
            AND c.status = 1
            <if test="query.categoryId != null">
                AND c.category_id = #{query.categoryId}
            </if>
            <if test="query.uploadedBy != null">
                AND c.uploaded_by = #{query.uploadedBy}
            </if>
            <if test="query.type != null">
                AND c.type = #{query.type}
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND (c.title LIKE CONCAT('%', #{query.keyword}, '%')
                OR c.description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
        GROUP BY c.id
        ORDER BY c.create_time DESC
    </select>

    <!-- ==================== AI 服务接口 ==================== -->

    <!-- AI内容信息结果映射 -->
    <resultMap id="ContentInfoResultMap" type="com.hngy.siae.api.ai.dto.response.ContentInfo">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="type" column="type"/>
        <result property="description" column="description"/>
        <result property="authorNickname" column="author_nickname"/>
        <result property="categoryName" column="category_name"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="publishTime" column="create_time"/>
    </resultMap>

    <!-- AI搜索内容（模糊匹配标题、描述、标签、分类） -->
    <select id="searchForAi" resultMap="ContentInfoResultMap">
        SELECT DISTINCT
            c.id,
            c.title,
            c.type,
            c.description,
            NULL as author_nickname,
            cat.name as category_name,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            c.create_time
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        LEFT JOIN tag_relation tr ON c.id = tr.content_id
        LEFT JOIN tag t ON tr.tag_id = t.id
        WHERE c.status = 2
        <if test="keyword != null and keyword != ''">
            AND (
                c.title LIKE CONCAT('%', #{keyword}, '%')
                OR c.description LIKE CONCAT('%', #{keyword}, '%')
                OR t.name LIKE CONCAT('%', #{keyword}, '%')
                OR cat.name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="categoryName != null and categoryName != ''">
            AND cat.name LIKE CONCAT('%', #{categoryName}, '%')
        </if>
        ORDER BY s.view_count DESC, c.create_time DESC
        LIMIT #{limit}
    </select>

    <!-- AI获取热门内容 -->
    <select id="getHotContentForAi" resultMap="ContentInfoResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            NULL as author_nickname,
            cat.name as category_name,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            c.create_time
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        WHERE c.status = 2
        ORDER BY s.view_count DESC, s.like_count DESC
        LIMIT #{limit}
    </select>

    <!-- AI获取最新内容 -->
    <select id="getLatestContentForAi" resultMap="ContentInfoResultMap">
        SELECT 
            c.id,
            c.title,
            c.type,
            c.description,
            NULL as author_nickname,
            cat.name as category_name,
            COALESCE(s.view_count, 0) as view_count,
            COALESCE(s.like_count, 0) as like_count,
            c.create_time
        FROM content c
        LEFT JOIN category cat ON c.category_id = cat.id
        LEFT JOIN statistics s ON c.id = s.content_id
        WHERE c.status = 2
        ORDER BY c.create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 统计收藏夹中已发布内容的数量 -->
    <select id="countPublishedFavoriteItems" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM favorite_item fi
        INNER JOIN content c ON fi.content_id = c.id
        WHERE fi.folder_id = #{folderId}
        AND c.status = 2
    </select>

</mapper>
