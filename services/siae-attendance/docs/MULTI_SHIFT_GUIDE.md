# 多时段考勤使用指南

## 快速开始

### 1. 初始化考勤规则

执行 SQL 文件创建三个时段的考勤规则：

```bash
mysql -u root -p attendance_db < src/main/resources/sql/init_attendance_rules.sql
```

或者在 MySQL 客户端中直接执行该文件。

### 2. 三个时段说明

| 时段 | 规则名称 | 签到时间 | 签退时间 | 优先级 |
|------|---------|---------|---------|--------|
| 上午 | 上午考勤 | 08:00-09:00 | 11:30-12:00 | 10 |
| 下午 | 下午考勤 | 14:00-14:30 | 17:30-18:00 | 20 |
| 晚上 | 晚上考勤 | 19:00-19:30 | 21:30-22:00 | 30 |

### 3. 使用场景

#### 场景 A：只参加晚上时段
```
19:20 签到 → 系统自动匹配"晚上考勤"规则
21:45 签退 → 完成晚上考勤
```

#### 场景 B：参加上午和下午
```
08:30 签到 → 匹配"上午考勤"
12:00 签退 → 完成上午考勤

14:15 签到 → 匹配"下午考勤"
18:00 签退 → 完成下午考勤
```

#### 场景 C：参加全天三个时段
```
08:30 签到 → 上午
12:00 签退

14:15 签到 → 下午
18:00 签退

19:20 签到 → 晚上
21:45 签退
```

## 工作原理

### 自动时段匹配
系统会根据**当前时间**自动选择对应的考勤规则：

- 08:00-09:00 之间签到 → 匹配"上午考勤"
- 14:00-14:30 之间签到 → 匹配"下午考勤"
- 19:00-19:30 之间签到 → 匹配"晚上考勤"

### 防重复机制
- ✅ 同一时段只能签到一次
- ✅ 不同时段可以分别签到
- ✅ 使用 Redis 锁防止并发重复

### 数据存储
每次签到都会创建独立的考勤记录，通过 `rule_id` 区分时段：

```sql
SELECT * FROM attendance_record WHERE user_id = 1001 AND attendance_date = '2024-11-24';
```

结果示例：
```
| id | user_id | rule_id | check_in_time | check_out_time | status |
|----|---------|---------|---------------|----------------|--------|
| 1  | 1001    | 1       | 08:30:00      | 12:00:00       | 已完成 |
| 2  | 1001    | 2       | 14:15:00      | 18:00:00       | 已完成 |
| 3  | 1001    | 3       | 19:20:00      | 21:45:00       | 已完成 |
```

## 自定义配置

### 调整时间窗口
如果需要修改签到/签退时间，直接更新规则表：

```sql
-- 修改上午签到时间为 07:30-08:30
UPDATE attendance_rule 
SET check_in_start_time = '07:30:00',
    check_in_end_time = '08:30:00'
WHERE id = 1;
```

### 添加新时段
如果需要增加第四个时段（如中午），插入新规则：

```sql
INSERT INTO attendance_rule (
    name, description,
    check_in_start_time, check_in_end_time,
    check_out_start_time, check_out_end_time,
    priority, ...
) VALUES (
    '中午考勤', '中午时段：12:00-14:00',
    '12:00:00', '12:30:00',
    '13:30:00', '14:00:00',
    15, ...
);
```

### 启用位置验证
如果需要验证签到位置：

```sql
UPDATE attendance_rule 
SET location_required = 1,
    allowed_locations = '[
        {"name": "办公室", "latitude": 39.9042, "longitude": 116.4074}
    ]',
    location_radius_meters = 100
WHERE id = 1;
```

## API 调用示例

### 签到请求
```json
POST /api/v1/attendance/check-in
{
    "userId": 1001,
    "timestamp": "2024-11-24T08:30:00",
    "location": "39.9042,116.4074",
    "attendanceType": 0
}
```

### 响应
```json
{
    "code": 200,
    "message": "操作成功",
    "data": {
        "id": 1,
        "userId": 1001,
        "attendanceType": "DAILY",
        "checkInTime": "2024-11-24T08:30:00",
        "attendanceDate": "2024-11-24",
        "status": "IN_PROGRESS"
    }
}
```

## 常见问题

### Q1: 如果在非签到时间窗口签到会怎样？
A: 系统会返回错误：`CHECK_IN_TIME_INVALID` (签到时间不在允许范围内)

### Q2: 可以在同一时段重复签到吗？
A: 不可以。系统会返回错误：`DUPLICATE_CHECK_IN` (今日已签到)

### Q3: 如何查看某个用户的所有考勤记录？
A: 调用查询接口，系统会返回该用户所有时段的考勤记录

### Q4: 可以动态增加时段吗？
A: 可以！只需在 `attendance_rule` 表中插入新规则即可，无需修改代码

## 总结

✅ **简单配置**：只需创建三个考勤规则  
✅ **自动匹配**：系统根据时间自动选择规则  
✅ **灵活扩展**：可随时增加新时段  
✅ **防重复**：同一时段不能重复签到  
✅ **独立管理**：每个时段的考勤记录独立存储
