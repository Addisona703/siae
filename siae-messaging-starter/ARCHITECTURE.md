# SIAE Messaging Starter æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¨¡å—ç»“æ„](#æ¨¡å—ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
5. [æ–‡ä»¶è¯´æ˜](#æ–‡ä»¶è¯´æ˜)
6. [è°ƒç”¨å…³ç³»](#è°ƒç”¨å…³ç³»)

---

## æ¦‚è¿°

`siae-messaging-starter` æ˜¯ä¸€ä¸ªåŸºäº Spring Boot çš„ RabbitMQ ç»Ÿä¸€æ¥å…¥ç»„ä»¶ï¼Œæä¾›ï¼š

- **è‡ªåŠ¨é…ç½®**ï¼šå¼€ç®±å³ç”¨çš„ RabbitMQ è¿æ¥å’Œæ‹“æ‰‘ç®¡ç†
- **æ¶ˆæ¯å‘é€**ï¼šç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æ¨¡æ¿ï¼Œæ”¯æŒé‡è¯•ã€ç¡®è®¤ã€æ‹¦æˆªå™¨
- **æ¶ˆæ¯æ¶ˆè´¹**ï¼šç®€åŒ–çš„æ¶ˆè´¹è€…æ³¨è§£ï¼Œæ”¯æŒé‡è¯•ã€é”™è¯¯å¤„ç†
- **åŠ¨æ€åˆ·æ–°**ï¼šæ”¯æŒè¿æ¥å‚æ•°çƒ­æ›´æ–°ï¼ˆé…åˆ Spring Cloud Configï¼‰
- **å¥åº·æ£€æŸ¥**ï¼šé›†æˆ Actuator å¥åº·æ£€æŸ¥
- **ç›‘æ§æŒ‡æ ‡**ï¼šé›†æˆ Micrometer æŒ‡æ ‡æ”¶é›†

---

## æ¨¡å—ç»“æ„

```
siae-messaging-starter/
â”œâ”€â”€ src/main/java/com/hngy/siae/messaging/
â”‚   â”œâ”€â”€ autoconfig/              # è‡ªåŠ¨é…ç½®åŒ…
â”‚   â”‚   â”œâ”€â”€ SiaeRabbitAutoConfiguration.java       # ä¸»é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ SiaeRabbitProperties.java              # é…ç½®å±æ€§
â”‚   â”‚   â”œâ”€â”€ SiaeRabbitInstanceManager.java         # å¤šå®ä¾‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ RabbitTemplateConfigurer.java          # æ¨¡æ¿é…ç½®å™¨
â”‚   â”‚   â””â”€â”€ RabbitTopologyUtils.java               # æ‹“æ‰‘å·¥å…·ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ producer/                # ç”Ÿäº§è€…åŒ…
â”‚   â”‚   â”œâ”€â”€ SiaeMessagingTemplate.java             # æ¶ˆæ¯å‘é€æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ MessageSendContext.java                # å‘é€ä¸Šä¸‹æ–‡
â”‚   â”‚   â”œâ”€â”€ MessageSendInterceptor.java            # å‘é€æ‹¦æˆªå™¨æ¥å£
â”‚   â”‚   â””â”€â”€ MessageSendException.java              # å‘é€å¼‚å¸¸
â”‚   â”‚
â”‚   â”œâ”€â”€ consumer/                # æ¶ˆè´¹è€…åŒ…
â”‚   â”‚   â”œâ”€â”€ SiaeRabbitListener.java                # æ¶ˆè´¹è€…æ³¨è§£
â”‚   â”‚   â””â”€â”€ SiaeRabbitListenerErrorHandler.java    # é”™è¯¯å¤„ç†å™¨
â”‚   â”‚
â”‚   â””â”€â”€ support/                 # æ”¯æŒåŒ…
â”‚       â”œâ”€â”€ headers/             # æ¶ˆæ¯å¤´å¤„ç†
â”‚       â”‚   â”œâ”€â”€ MessageHeaderEnricher.java         # æ¶ˆæ¯å¤´å¢å¼ºæ¥å£
â”‚       â”‚   â””â”€â”€ DefaultMessageHeaderEnricher.java  # é»˜è®¤å®ç°
â”‚       â”‚
â”‚       â”œâ”€â”€ interceptor/         # æ‹¦æˆªå™¨å®ç°
â”‚       â”‚   â”œâ”€â”€ HeaderEnrichingInterceptor.java    # æ¶ˆæ¯å¤´æ‹¦æˆªå™¨
â”‚       â”‚   â””â”€â”€ MessagingMetricsInterceptor.java   # æŒ‡æ ‡æ‹¦æˆªå™¨
â”‚       â”‚
â”‚       â”œâ”€â”€ serializer/          # åºåˆ—åŒ–
â”‚       â”‚   â”œâ”€â”€ MessageConverterAdapter.java       # è½¬æ¢å™¨æ¥å£
â”‚       â”‚   â””â”€â”€ JacksonMessageConverterAdapter.java # Jacksonå®ç°
â”‚       â”‚
â”‚       â”œâ”€â”€ health/              # å¥åº·æ£€æŸ¥
â”‚       â”‚   â””â”€â”€ SiaeRabbitHealthIndicator.java     # å¥åº·æŒ‡ç¤ºå™¨
â”‚       â”‚
â”‚       â”œâ”€â”€ refresh/             # åŠ¨æ€åˆ·æ–°
â”‚       â”‚   â”œâ”€â”€ SiaeRabbitConnectionRefresher.java # è¿æ¥åˆ·æ–°å™¨
â”‚       â”‚   â””â”€â”€ SiaeRabbitEnvironmentChangeListener.java # ç¯å¢ƒå˜æ›´ç›‘å¬
â”‚       â”‚
â”‚       â””â”€â”€ logging/             # æ—¥å¿—
â”‚           â””â”€â”€ RabbitStartupLogger.java           # å¯åŠ¨æ—¥å¿—
â”‚
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ META-INF/spring/
â”‚       â””â”€â”€ org.springframework.boot.autoconfigure.AutoConfiguration.imports
â”‚
â”œâ”€â”€ README.md                    # ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ MIGRATION.md                 # è¿ç§»æŒ‡å—
â””â”€â”€ pom.xml                      # Maven é…ç½®
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. è‡ªåŠ¨é…ç½®å±‚ (autoconfig)

#### **SiaeRabbitAutoConfiguration**
- **ä½œç”¨**ï¼šSpring Boot è‡ªåŠ¨é…ç½®ç±»ï¼Œè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰ RabbitMQ ç›¸å…³çš„ Bean
- **èŒè´£**ï¼š
  - åˆ›å»º `CachingConnectionFactory`ï¼ˆè¿æ¥å·¥å‚ï¼‰
  - åˆ›å»º `RabbitTemplate`ï¼ˆæ¶ˆæ¯å‘é€æ¨¡æ¿ï¼‰
  - åˆ›å»º `RabbitAdmin`ï¼ˆæ‹“æ‰‘ç®¡ç†ï¼‰
  - åˆ›å»º `SimpleRabbitListenerContainerFactory`ï¼ˆæ¶ˆè´¹è€…å®¹å™¨å·¥å‚ï¼‰
  - æ³¨å†Œæ‹¦æˆªå™¨ã€å¥åº·æ£€æŸ¥ã€æŒ‡æ ‡æ”¶é›†ç­‰ç»„ä»¶

#### **SiaeRabbitProperties**
- **ä½œç”¨**ï¼šé…ç½®å±æ€§ç±»ï¼Œæ˜ å°„ `siae.messaging.rabbit.*` é…ç½®
- **åŒ…å«**ï¼š
  - `Connection`ï¼šè¿æ¥é…ç½®ï¼ˆåœ°å€ã€ç”¨æˆ·åã€å¯†ç ã€è™šæ‹Ÿä¸»æœºï¼‰
  - `Publisher`ï¼šå‘å¸ƒè€…é…ç½®ï¼ˆç¡®è®¤ã€è¿”å›ã€é‡è¯•ï¼‰
  - `Consumer`ï¼šæ¶ˆè´¹è€…é…ç½®ï¼ˆå¹¶å‘æ•°ã€é¢„å–æ•°é‡ã€é‡è¯•ï¼‰
  - `Exchange`ï¼šäº¤æ¢æœºé…ç½®
  - `Queue`ï¼šé˜Ÿåˆ—é…ç½®
  - `Binding`ï¼šç»‘å®šé…ç½®

#### **SiaeRabbitInstanceManager**
- **ä½œç”¨**ï¼šç®¡ç†å¤šä¸ª RabbitMQ å®ä¾‹ï¼ˆæ”¯æŒè¿æ¥å¤šä¸ª RabbitMQ é›†ç¾¤ï¼‰
- **èŒè´£**ï¼š
  - ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºç‹¬ç«‹çš„è¿æ¥å·¥å‚
  - ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºç‹¬ç«‹çš„æ¶ˆæ¯æ¨¡æ¿
  - æä¾›å®ä¾‹æŸ¥è¯¢å’Œåˆ‡æ¢åŠŸèƒ½

#### **RabbitTemplateConfigurer**
- **ä½œç”¨**ï¼šé…ç½® `RabbitTemplate` çš„ç¡®è®¤å’Œè¿”å›å›è°ƒ
- **èŒè´£**ï¼š
  - é…ç½® Publisher Confirm å›è°ƒï¼ˆæ¶ˆæ¯æ˜¯å¦åˆ°è¾¾äº¤æ¢æœºï¼‰
  - é…ç½® Publisher Return å›è°ƒï¼ˆæ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—ï¼‰

#### **RabbitTopologyUtils**
- **ä½œç”¨**ï¼šRabbitMQ æ‹“æ‰‘ç»“æ„å·¥å…·ç±»
- **èŒè´£**ï¼š
  - æ ¹æ®é…ç½®åˆ›å»º Exchangeã€Queueã€Binding
  - è‡ªåŠ¨å£°æ˜æ‹“æ‰‘ç»“æ„åˆ° RabbitMQ

---

### 2. ç”Ÿäº§è€…å±‚ (producer)

#### **SiaeMessagingTemplate**
- **ä½œç”¨**ï¼šç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æ¨¡æ¿ï¼Œå°è£… `RabbitTemplate`
- **åŠŸèƒ½**ï¼š
  - åŒæ­¥å‘é€ï¼š`send(exchange, routingKey, payload)`
  - å¼‚æ­¥å‘é€ï¼š`sendAsync(exchange, routingKey, payload)`
  - è‡ªåŠ¨é‡è¯•ï¼šæ”¯æŒæŒ‡æ•°é€€é¿é‡è¯•
  - æ‹¦æˆªå™¨é“¾ï¼šæ”¯æŒå‘é€å‰åçš„æ‹¦æˆªå¤„ç†
  - æ¶ˆæ¯IDç”Ÿæˆï¼šè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
  - æ¶ˆæ¯å¤´å¢å¼ºï¼šè‡ªåŠ¨æ·»åŠ è¿½è¸ªIDã€ç§Ÿæˆ·IDç­‰

#### **MessageSendContext**
- **ä½œç”¨**ï¼šæ¶ˆæ¯å‘é€ä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿æ•´ä¸ªå‘é€æµç¨‹
- **åŒ…å«**ï¼š
  - äº¤æ¢æœºã€è·¯ç”±é”®ã€æ¶ˆæ¯ä½“
  - æ¶ˆæ¯å¤´ï¼ˆHeadersï¼‰
  - æ¶ˆæ¯IDã€å…³è”æ•°æ®
  - é‡è¯•æ¬¡æ•°

#### **MessageSendInterceptor**
- **ä½œç”¨**ï¼šæ¶ˆæ¯å‘é€æ‹¦æˆªå™¨æ¥å£
- **æ–¹æ³•**ï¼š
  - `beforeSend(context)`ï¼šå‘é€å‰æ‹¦æˆª
  - `afterSend(context)`ï¼šå‘é€åæ‹¦æˆª
  - `onError(context, throwable)`ï¼šå‘é€å¤±è´¥æ‹¦æˆª

---

### 3. æ¶ˆè´¹è€…å±‚ (consumer)

#### **@SiaeRabbitListener**
- **ä½œç”¨**ï¼šæ¶ˆè´¹è€…æ³¨è§£ï¼Œå°è£… `@RabbitListener`
- **åŠŸèƒ½**ï¼š
  - è‡ªåŠ¨ä½¿ç”¨ `siaeListenerContainerFactory`
  - è‡ªåŠ¨ä½¿ç”¨ `siaeRabbitListenerErrorHandler`
  - æ”¯æŒæ‰€æœ‰ `@RabbitListener` çš„å±æ€§

#### **SiaeRabbitListenerErrorHandler**
- **ä½œç”¨**ï¼šç»Ÿä¸€çš„æ¶ˆè´¹è€…é”™è¯¯å¤„ç†å™¨
- **èŒè´£**ï¼š
  - è®°å½•é”™è¯¯æ—¥å¿—
  - å†³å®šæ˜¯å¦é‡æ–°å…¥é˜Ÿ
  - è§¦å‘æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰

---

### 4. æ”¯æŒå±‚ (support)

#### **æ¶ˆæ¯å¤´å¤„ç† (headers)**

**MessageHeaderEnricher**
- æ¶ˆæ¯å¤´å¢å¼ºæ¥å£ï¼Œç”¨äºåœ¨å‘é€å‰è‡ªåŠ¨æ·»åŠ å…¬å…±æ¶ˆæ¯å¤´

**DefaultMessageHeaderEnricher**
- é»˜è®¤å®ç°ï¼Œè‡ªåŠ¨æ·»åŠ ï¼š
  - `X-Trace-Id`ï¼šè¿½è¸ªIDï¼ˆç”¨äºé“¾è·¯è¿½è¸ªï¼‰
  - `X-Tenant-Id`ï¼šç§Ÿæˆ·IDï¼ˆç”¨äºå¤šç§Ÿæˆ·éš”ç¦»ï¼‰
  - `X-Timestamp`ï¼šæ—¶é—´æˆ³

#### **æ‹¦æˆªå™¨ (interceptor)**

**HeaderEnrichingInterceptor**
- æ¶ˆæ¯å¤´å¢å¼ºæ‹¦æˆªå™¨ï¼Œåœ¨å‘é€å‰è°ƒç”¨ `MessageHeaderEnricher`

**MessagingMetricsInterceptor**
- æŒ‡æ ‡æ”¶é›†æ‹¦æˆªå™¨ï¼Œé›†æˆ Micrometerï¼Œæ”¶é›†ï¼š
  - æ¶ˆæ¯å‘é€æ¬¡æ•°
  - æ¶ˆæ¯å‘é€è€—æ—¶
  - æ¶ˆæ¯å‘é€å¤±è´¥æ¬¡æ•°

#### **åºåˆ—åŒ– (serializer)**

**MessageConverterAdapter**
- æ¶ˆæ¯è½¬æ¢å™¨æ¥å£ï¼Œå®šä¹‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•

**JacksonMessageConverterAdapter**
- åŸºäº Jackson çš„å®ç°ï¼Œæ”¯æŒ JSON åºåˆ—åŒ–

#### **å¥åº·æ£€æŸ¥ (health)**

**SiaeRabbitHealthIndicator**
- å¥åº·æ£€æŸ¥æŒ‡ç¤ºå™¨ï¼Œæ£€æŸ¥ RabbitMQ è¿æ¥çŠ¶æ€
- é›†æˆ Spring Boot Actuatorï¼Œé€šè¿‡ `/actuator/health` æŸ¥çœ‹

#### **åŠ¨æ€åˆ·æ–° (refresh)**

**SiaeRabbitConnectionRefresher**
- è¿æ¥åˆ·æ–°å™¨ï¼Œæ”¯æŒçƒ­æ›´æ–°è¿æ¥å‚æ•°ï¼ˆåœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼‰

**SiaeRabbitEnvironmentChangeListener**
- ç¯å¢ƒå˜æ›´ç›‘å¬å™¨ï¼Œç›‘å¬ Spring Cloud Config çš„é…ç½®å˜æ›´äº‹ä»¶

#### **æ—¥å¿— (logging)**

**RabbitStartupLogger**
- å¯åŠ¨æ—¥å¿—è®°å½•å™¨ï¼Œåœ¨åº”ç”¨å¯åŠ¨åæ‰“å° RabbitMQ è¿æ¥ä¿¡æ¯

---

## å·¥ä½œæµç¨‹

### æ¶ˆæ¯å‘é€æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸šåŠ¡ä»£ç è°ƒç”¨                                              â”‚
â”‚    messagingTemplate.send(exchange, routingKey, payload)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SiaeMessagingTemplate                                    â”‚
â”‚    - åˆ›å»º MessageSendContext                                â”‚
â”‚    - ç”Ÿæˆæ¶ˆæ¯ID                                              â”‚
â”‚    - è®¾ç½®é‡è¯•æ¬¡æ•°                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‹¦æˆªå™¨é“¾ - beforeSend()                                  â”‚
â”‚    â”œâ”€ HeaderEnrichingInterceptor                           â”‚
â”‚    â”‚   â””â”€ æ·»åŠ  X-Trace-Id, X-Tenant-Id                     â”‚
â”‚    â””â”€ MessagingMetricsInterceptor                          â”‚
â”‚        â””â”€ å¼€å§‹è®¡æ—¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RabbitTemplate.convertAndSend()                         â”‚
â”‚    - åºåˆ—åŒ–æ¶ˆæ¯ï¼ˆJacksonï¼‰                                   â”‚
â”‚    - å‘é€åˆ° RabbitMQ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RabbitMQ Broker                                         â”‚
â”‚    - æ¥æ”¶æ¶ˆæ¯                                               â”‚
â”‚    - è·¯ç”±åˆ°é˜Ÿåˆ—                                             â”‚
â”‚    - è¿”å›ç¡®è®¤ï¼ˆå¦‚æœå¼€å¯ Publisher Confirmï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å›è°ƒå¤„ç†                                                 â”‚
â”‚    â”œâ”€ ConfirmCallbackï¼ˆç¡®è®¤å›è°ƒï¼‰                           â”‚
â”‚    â”‚   â””â”€ è®°å½•ç¡®è®¤ç»“æœ                                      â”‚
â”‚    â””â”€ ReturnCallbackï¼ˆè¿”å›å›è°ƒï¼‰                            â”‚
â”‚        â””â”€ è®°å½•æœªè·¯ç”±æ¶ˆæ¯                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ‹¦æˆªå™¨é“¾ - afterSend()                                   â”‚
â”‚    â””â”€ MessagingMetricsInterceptor                          â”‚
â”‚        â””â”€ åœæ­¢è®¡æ—¶ï¼Œè®°å½•æŒ‡æ ‡                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯æ¶ˆè´¹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. RabbitMQ Broker                                         â”‚
â”‚    - æ¨é€æ¶ˆæ¯åˆ°æ¶ˆè´¹è€…                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SimpleRabbitListenerContainer                           â”‚
â”‚    - æ¥æ”¶æ¶ˆæ¯                                               â”‚
â”‚    - ååºåˆ—åŒ–ï¼ˆJacksonï¼‰                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. @SiaeRabbitListener æ–¹æ³•                                 â”‚
â”‚    - æ‰§è¡Œä¸šåŠ¡é€»è¾‘                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€ æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                         â”‚
                     â””â”€ å¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                               â”‚
                                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é”™è¯¯å¤„ç†                                                 â”‚
â”‚    â”œâ”€ SiaeRabbitListenerErrorHandler                       â”‚
â”‚    â”‚   â””â”€ è®°å½•é”™è¯¯æ—¥å¿—                                      â”‚
â”‚    â””â”€ RetryInterceptorï¼ˆå¦‚æœé…ç½®äº†é‡è¯•ï¼‰                    â”‚
â”‚        â”œâ”€ é‡è¯•æ¬¡æ•° < maxAttempts â”€â”€> é‡æ–°å…¥é˜Ÿ               â”‚
â”‚        â””â”€ é‡è¯•æ¬¡æ•° >= maxAttempts â”€â”€> æ‹’ç»æ¶ˆæ¯ï¼ˆDLQï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ¶ˆæ¯ç¡®è®¤                                                 â”‚
â”‚    â”œâ”€ æˆåŠŸï¼šACKï¼ˆç¡®è®¤ï¼‰                                     â”‚
â”‚    â”œâ”€ å¤±è´¥ä¸”é‡è¯•ï¼šNACK + Requeueï¼ˆé‡æ–°å…¥é˜Ÿï¼‰                â”‚
â”‚    â””â”€ å¤±è´¥ä¸”ä¸é‡è¯•ï¼šNACK + No Requeueï¼ˆæ‹’ç»ï¼Œè¿›å…¥DLQï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡ä»¶è¯´æ˜

### è‡ªåŠ¨é…ç½®åŒ… (autoconfig)

| æ–‡ä»¶ | ä½œç”¨ | å…³é”®æ–¹æ³• |
|------|------|---------|
| `SiaeRabbitAutoConfiguration` | ä¸»é…ç½®ç±»ï¼Œæ³¨å†Œæ‰€æœ‰ Bean | `siaeRabbitConnectionFactory()`<br>`siaeRabbitTemplate()`<br>`siaeMessagingTemplate()` |
| `SiaeRabbitProperties` | é…ç½®å±æ€§æ˜ å°„ | `getConnection()`<br>`getPublisher()`<br>`getConsumer()` |
| `SiaeRabbitInstanceManager` | å¤šå®ä¾‹ç®¡ç†å™¨ | `getInstance(name)`<br>`getMessagingTemplate(name)` |
| `RabbitTemplateConfigurer` | æ¨¡æ¿é…ç½®å™¨ | `configureTemplate()` |
| `RabbitTopologyUtils` | æ‹“æ‰‘å·¥å…·ç±» | `buildDeclarables()`<br>`declareTopology()` |

### ç”Ÿäº§è€…åŒ… (producer)

| æ–‡ä»¶ | ä½œç”¨ | å…³é”®æ–¹æ³• |
|------|------|---------|
| `SiaeMessagingTemplate` | æ¶ˆæ¯å‘é€æ¨¡æ¿ | `send()`<br>`sendAsync()`<br>`executeSend()` |
| `MessageSendContext` | å‘é€ä¸Šä¸‹æ–‡ | `getExchange()`<br>`getRoutingKey()`<br>`getPayload()` |
| `MessageSendInterceptor` | æ‹¦æˆªå™¨æ¥å£ | `beforeSend()`<br>`afterSend()`<br>`onError()` |
| `MessageSendException` | å‘é€å¼‚å¸¸ | - |

### æ¶ˆè´¹è€…åŒ… (consumer)

| æ–‡ä»¶ | ä½œç”¨ | å…³é”®æ–¹æ³• |
|------|------|---------|
| `@SiaeRabbitListener` | æ¶ˆè´¹è€…æ³¨è§£ | - |
| `SiaeRabbitListenerErrorHandler` | é”™è¯¯å¤„ç†å™¨ | `handleError()` |

### æ”¯æŒåŒ… (support)

| å­åŒ… | æ–‡ä»¶ | ä½œç”¨ |
|------|------|------|
| **headers** | `MessageHeaderEnricher` | æ¶ˆæ¯å¤´å¢å¼ºæ¥å£ |
| | `DefaultMessageHeaderEnricher` | é»˜è®¤å®ç°ï¼ˆæ·»åŠ è¿½è¸ªIDç­‰ï¼‰ |
| **interceptor** | `HeaderEnrichingInterceptor` | æ¶ˆæ¯å¤´æ‹¦æˆªå™¨ |
| | `MessagingMetricsInterceptor` | æŒ‡æ ‡æ”¶é›†æ‹¦æˆªå™¨ |
| **serializer** | `MessageConverterAdapter` | è½¬æ¢å™¨æ¥å£ |
| | `JacksonMessageConverterAdapter` | Jackson å®ç° |
| **health** | `SiaeRabbitHealthIndicator` | å¥åº·æ£€æŸ¥ |
| **refresh** | `SiaeRabbitConnectionRefresher` | è¿æ¥åˆ·æ–°å™¨ |
| | `SiaeRabbitEnvironmentChangeListener` | ç¯å¢ƒå˜æ›´ç›‘å¬ |
| **logging** | `RabbitStartupLogger` | å¯åŠ¨æ—¥å¿— |

---

## è°ƒç”¨å…³ç³»

### å¯åŠ¨æ—¶åˆå§‹åŒ–

```
Application å¯åŠ¨
    â”‚
    â–¼
SiaeRabbitAutoConfiguration
    â”‚
    â”œâ”€> siaeRabbitConnectionFactory()
    â”‚   â””â”€> åˆ›å»º CachingConnectionFactory
    â”‚
    â”œâ”€> siaeRabbitTemplate()
    â”‚   â”œâ”€> ä½¿ç”¨ CachingConnectionFactory
    â”‚   â””â”€> RabbitTemplateConfigurer.configureTemplate()
    â”‚
    â”œâ”€> siaeRabbitAdmin()
    â”‚   â””â”€> ä½¿ç”¨ CachingConnectionFactory
    â”‚
    â”œâ”€> siaeRabbitDeclarables()
    â”‚   â”œâ”€> RabbitTopologyUtils.buildDeclarables()
    â”‚   â””â”€> RabbitTopologyUtils.declareTopology()
    â”‚
    â”œâ”€> siaeMessagingTemplate()
    â”‚   â”œâ”€> ä½¿ç”¨ RabbitTemplate
    â”‚   â””â”€> æ³¨å…¥æ‹¦æˆªå™¨åˆ—è¡¨
    â”‚
    â”œâ”€> siaeListenerContainerFactory()
    â”‚   â”œâ”€> ä½¿ç”¨ CachingConnectionFactory
    â”‚   â””â”€> é…ç½®é‡è¯•æ‹¦æˆªå™¨
    â”‚
    â””â”€> å…¶ä»–æ”¯æŒç»„ä»¶
        â”œâ”€> messageHeaderEnricher()
        â”œâ”€> headerEnrichingInterceptor()
        â”œâ”€> messagingMetricsInterceptor()
        â”œâ”€> siaeRabbitHealthIndicator()
        â””â”€> rabbitStartupLogger()
```

### æ¶ˆæ¯å‘é€è°ƒç”¨é“¾

```
ä¸šåŠ¡ä»£ç 
    â”‚
    â–¼
SiaeMessagingTemplate.send()
    â”‚
    â”œâ”€> executeSend()
    â”‚   â”‚
    â”‚   â”œâ”€> RetryTemplate.execute() (å¦‚æœé…ç½®äº†é‡è¯•)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€> doSend()
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€> åˆ›å»º MessageSendContext
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€> notifyBefore()
    â”‚   â”‚       â”‚   â””â”€> è°ƒç”¨æ‰€æœ‰æ‹¦æˆªå™¨çš„ beforeSend()
    â”‚   â”‚       â”‚       â”œâ”€> HeaderEnrichingInterceptor.beforeSend()
    â”‚   â”‚       â”‚       â”‚   â””â”€> MessageHeaderEnricher.enrich()
    â”‚   â”‚       â”‚       â””â”€> MessagingMetricsInterceptor.beforeSend()
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€> RabbitTemplate.convertAndSend()
    â”‚   â”‚       â”‚   â”‚
    â”‚   â”‚       â”‚   â”œâ”€> MessageConverter.toMessage() (åºåˆ—åŒ–)
    â”‚   â”‚       â”‚   â”‚   â””â”€> JacksonMessageConverterAdapter
    â”‚   â”‚       â”‚   â”‚
    â”‚   â”‚       â”‚   â””â”€> å‘é€åˆ° RabbitMQ
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€> notifyAfter()
    â”‚   â”‚       â”‚   â””â”€> è°ƒç”¨æ‰€æœ‰æ‹¦æˆªå™¨çš„ afterSend()
    â”‚   â”‚       â”‚       â””â”€> MessagingMetricsInterceptor.afterSend()
    â”‚   â”‚       â”‚
    â”‚   â”‚       â””â”€> (å¼‚å¸¸æ—¶) notifyError()
    â”‚   â”‚           â””â”€> è°ƒç”¨æ‰€æœ‰æ‹¦æˆªå™¨çš„ onError()
    â”‚   â”‚
    â”‚   â””â”€> (é‡è¯•å¤±è´¥) æŠ›å‡º MessageSendException
    â”‚
    â””â”€> RabbitTemplate å›è°ƒ
        â”œâ”€> ConfirmCallback (ç¡®è®¤å›è°ƒ)
        â””â”€> ReturnCallback (è¿”å›å›è°ƒ)
```

### æ¶ˆæ¯æ¶ˆè´¹è°ƒç”¨é“¾

```
RabbitMQ Broker æ¨é€æ¶ˆæ¯
    â”‚
    â–¼
SimpleRabbitListenerContainer
    â”‚
    â”œâ”€> MessageConverter.fromMessage() (ååºåˆ—åŒ–)
    â”‚   â””â”€> JacksonMessageConverterAdapter
    â”‚
    â”œâ”€> RetryInterceptor (å¦‚æœé…ç½®äº†é‡è¯•)
    â”‚   â”‚
    â”‚   â””â”€> æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
    â”‚       â”‚
    â”‚       â”œâ”€> @SiaeRabbitListener æ–¹æ³•
    â”‚       â”‚   â””â”€> ä¸šåŠ¡é€»è¾‘
    â”‚       â”‚
    â”‚       â””â”€> (å¼‚å¸¸æ—¶) SiaeRabbitListenerErrorHandler.handleError()
    â”‚           â”‚
    â”‚           â”œâ”€> è®°å½•é”™è¯¯æ—¥å¿—
    â”‚           â”‚
    â”‚           â””â”€> åˆ¤æ–­æ˜¯å¦é‡è¯•
    â”‚               â”œâ”€> é‡è¯•æ¬¡æ•° < maxAttempts
    â”‚               â”‚   â””â”€> æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
    â”‚               â”‚
    â”‚               â””â”€> é‡è¯•æ¬¡æ•° >= maxAttempts
    â”‚                   â””â”€> æŠ›å‡º AmqpRejectAndDontRequeueException
    â”‚                       â””â”€> æ¶ˆæ¯è¿›å…¥ DLQ
    â”‚
    â””â”€> æ¶ˆæ¯ç¡®è®¤
        â”œâ”€> æˆåŠŸï¼šchannel.basicAck()
        â”œâ”€> å¤±è´¥ä¸”é‡è¯•ï¼šchannel.basicNack(requeue=true)
        â””â”€> å¤±è´¥ä¸”ä¸é‡è¯•ï¼šchannel.basicNack(requeue=false)
```

---

## é…ç½®ç¤ºä¾‹

### åŸºç¡€é…ç½®

```yaml
siae:
  messaging:
    rabbit:
      # è¿æ¥é…ç½®
      connection:
        addresses: localhost:5672
        username: guest
        password: guest
        virtual-host: /
        requested-heartbeat: 30
        ssl-enabled: false
      
      # å‘å¸ƒè€…é…ç½®
      publisher:
        confirms: true          # å¼€å¯ç¡®è®¤
        returns: true           # å¼€å¯è¿”å›
        retry:
          enabled: true         # å¼€å¯é‡è¯•
          max-attempts: 3       # æœ€å¤§é‡è¯•æ¬¡æ•°
          initial-interval: 500 # åˆå§‹é—´éš”ï¼ˆæ¯«ç§’ï¼‰
          multiplier: 2.0       # å€æ•°
          max-interval: 5000    # æœ€å¤§é—´éš”ï¼ˆæ¯«ç§’ï¼‰
      
      # æ¶ˆè´¹è€…é…ç½®
      consumer:
        concurrency: 3          # å¹¶å‘æ¶ˆè´¹è€…æ•°
        max-concurrency: 10     # æœ€å¤§å¹¶å‘æ•°
        prefetch: 50            # é¢„å–æ•°é‡
        retry:
          enabled: true
          max-attempts: 3
          initial-interval: 1000
          multiplier: 2.0
          max-interval: 10000
      
      # äº¤æ¢æœºé…ç½®
      exchanges:
        siae.notification.exchange:
          type: topic
          durable: true
      
      # é˜Ÿåˆ—é…ç½®
      queues:
        siae.notification.queue:
          durable: true
      
      # ç»‘å®šé…ç½®
      bindings:
        notification-binding:
          exchange: siae.notification.exchange
          destination: siae.notification.queue
          routing-key: notification.#
```

---

## æ€»ç»“

`siae-messaging-starter` é€šè¿‡åˆ†å±‚è®¾è®¡å’Œæ¨¡å—åŒ–æ¶æ„ï¼Œæä¾›äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ˜“äºä½¿ç”¨çš„ RabbitMQ æ¥å…¥æ–¹æ¡ˆï¼š

1. **è‡ªåŠ¨é…ç½®å±‚**ï¼šè´Ÿè´£åˆå§‹åŒ–å’Œé…ç½®ç®¡ç†
2. **ç”Ÿäº§è€…å±‚**ï¼šæä¾›ç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æ¥å£
3. **æ¶ˆè´¹è€…å±‚**ï¼šç®€åŒ–æ¶ˆæ¯æ¶ˆè´¹å’Œé”™è¯¯å¤„ç†
4. **æ”¯æŒå±‚**ï¼šæä¾›æ‹¦æˆªå™¨ã€åºåˆ—åŒ–ã€å¥åº·æ£€æŸ¥ç­‰å¢å¼ºåŠŸèƒ½

é€šè¿‡æ‹¦æˆªå™¨æœºåˆ¶ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åŠŸèƒ½ï¼ˆå¦‚é“¾è·¯è¿½è¸ªã€æŒ‡æ ‡æ”¶é›†ï¼‰ï¼›é€šè¿‡é…ç½®åŒ–ç®¡ç†ï¼Œå¯ä»¥çµæ´»æ§åˆ¶è¡Œä¸ºï¼ˆå¦‚é‡è¯•ç­–ç•¥ã€å¹¶å‘æ•°ï¼‰ã€‚

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX  
**ç»´æŠ¤äººå‘˜**ï¼šSIAE å¼€å‘å›¢é˜Ÿ
