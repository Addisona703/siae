# ===================================================================
# LOCAL CONFIGURATION FOR SIAE-GATEWAY
# 本地开发配置，不使用 Nacos
# ===================================================================

server:
  port: 80

spring:
  application:
    name: siae-gateway
  
  # 禁用 Nacos
  cloud:
    nacos:
      discovery:
        enabled: true
      config:
        enabled: false
    
    gateway:
      discovery:
        locator:
          enabled: true # 启用服务发现
          lower-case-service-id: true # 服务名小写
      routes:
        # 认证服务路由
        - id: siae-auth-route
          uri: lb://siae-auth
          predicates:
            - Path=/api/v1/auth/**
          # filters:
          #   - RewritePath=/api/v1/auth/(?<segment>.*),/${segment}

        # 用户服务路由
        - id: siae-user-route
          uri: lb://siae-user
          predicates:
            - Path=/api/v1/user/**
          # filters:
          #   - RewritePath=/api/v1/user/(?<segment>.*),/${segment}

        # 内容服务路由
        - id: siae-content-route
          uri: lb://siae-content
          predicates:
            - Path=/api/v1/content/**
          # filters:
          #   - RewritePath=/api/v1/content/(?<segment>.*),/${segment}

        # 通知服务路由
        - id: siae-notification-route
          uri: lb://siae-notification
          predicates:
            - Path=/api/v1/notification/**

        # 媒体服务路由
        - id: siae-media-route
          uri: lb://siae-media
          predicates:
            - Path=/api/v1/media/**
          # filters:
          #   # 限流配置：每秒最多100个请求
          #   - name: RequestRateLimiter
          #     args:
          #       key-resolver: "#{@gatewayUserKeyResolver}"
          #       redis-rate-limiter.replenishRate: 100
          #       redis-rate-limiter.burstCapacity: 200
          #       redis-rate-limiter.requestedTokens: 1
          #   # 熔断配置
          #   - name: CircuitBreaker
          #     args:
          #       name: mediaServiceCircuitBreaker
          #       fallbackUri: forward:/fallback/media

        # 考勤服务路由
        - id: siae-attendance-route
          uri: lb://siae-attendance
          predicates:
            - Path=/api/v1/attendance/**

        # OpenAPI文档路由
        - id: openapi-route
          uri: lb://siae-gateway
          predicates:
            - Path=/v3/api-docs/**
          # filters:
          #   - RewritePath=/v3/api-docs/(?<segment>.*),/$\{segment}/v3/api-docs
  # Redis 配置
  data:
    redis:
      host: localhost
      port: 6379
      password: 123456
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

# Actuator 端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

# SpringDoc API 文档配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    config-url: /v3/api-docs/swagger-config
    urls:
      - url: /v3/api-docs/siae-user
        name: 用户服务
      - url: /v3/api-docs/siae-auth
        name: 认证服务
      - url: /v3/api-docs/siae-content
        name: 内容服务
      - url: /v3/api-docs/siae-notification
        name: 通知服务
      - url: /v3/api-docs/siae-media
        name: 媒体服务
      - url: /v3/api-docs/siae-attendance
        name: 考勤服务

# 日志配置
logging:
  level:
    root: INFO
    com.hngy.siae: DEBUG
    org.springframework.cloud.gateway: DEBUG
