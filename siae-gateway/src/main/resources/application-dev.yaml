# ===================================================================
# REMOTE CONFIGURATION (Managed in Nacos)
# Contains all application-specific configurations for siae-gateway in dev environment.
# ===================================================================

# 服务端口
server:
  port: 80

# Spring Cloud Gateway配置
spring:
  application:
    name: siae-gateway
  cloud:
    # Nacos服务发现配置 (注意: discovery的配置也可以放在这里)
    nacos:
      discovery:
        server-addr: ${spring.cloud.nacos.server-addr} # 建议引用bootstrap中的地址，保持一致
      config:
        server-addr: localhost:8848
        file-extension: yaml
        shared-configs:
          - dataId: siae-common.yaml
            refresh: true
    gateway:
      discovery:
        locator:
          enabled: true # 启用服务发现
          lower-case-service-id: true # 服务名小写
      routes:
        # 认证服务路由
        - id: siae-auth-route
          uri: lb://siae-auth
          predicates:
            - Path=/api/v1/auth/**
          # filters:
          #   - RewritePath=/api/v1/auth/(?<segment>.*),/${segment}

        # 用户服务路由
        - id: siae-user-route
          uri: lb://siae-user
          predicates:
            - Path=/api/v1/user/**
          # filters:
          #   - RewritePath=/api/v1/user/(?<segment>.*),/${segment}

        # 内容服务路由
        - id: siae-content-route
          uri: lb://siae-content
          predicates:
            - Path=/api/v1/content/**
          # filters:
          #   - RewritePath=/api/v1/content/(?<segment>.*),/${segment}

        # 通知服务路由
        - id: siae-notification-route
          uri: lb://siae-notification
          predicates:
            - Path=/api/v1/notification/**

        # 媒体服务路由
        - id: siae-media-route
          uri: lb://siae-media
          predicates:
            - Path=/api/v1/media/**
          # filters:
          #   # 限流配置：每秒最多100个请求
          #   - name: RequestRateLimiter
          #     args:
          #       key-resolver: "#{@gatewayUserKeyResolver}"
          #       redis-rate-limiter.replenishRate: 100
          #       redis-rate-limiter.burstCapacity: 200
          #       redis-rate-limiter.requestedTokens: 1
          #   # 熔断配置
          #   - name: CircuitBreaker
          #     args:
          #       name: mediaServiceCircuitBreaker
          #       fallbackUri: forward:/fallback/media

        # OpenAPI文档路由
        - id: openapi-route
          uri: lb://siae-gateway
          predicates:
            - Path=/v3/api-docs/**
          # filters:
          #   - RewritePath=/v3/api-docs/(?<segment>.*),/$\{segment}/v3/api-docs
  data:
    redis:
      host: localhost
      port: 6379
      password: 123456 # Set if Redis has password
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

# 开启Actuator端点
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

# SpringDoc配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    config-url: /v3/api-docs/swagger-config
    urls:
      - url: /v3/api-docs/siae-user
        name: 用户服务
      - url: /v3/api-docs/siae-auth
        name: 认证服务
      - url: /v3/api-docs/siae-content
        name: 内容服务
      - url: /v3/api-docs/siae-notification
        name: 通知服务
      - url: /v3/api-docs/siae-media
        name: 媒体服务
